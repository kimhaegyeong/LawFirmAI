#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
?? ?집 관???이??모델 ?의
"""

from dataclasses import dataclass, field
from datetime import datetime, timedelta
from enum import Enum
from typing import Dict, Any, Optional


class CollectionStatus(Enum):
    """?집 ?태 ?거??""
    PENDING = "pending"
    IN_PROGRESS = "in_progress"
    COMPLETED = "completed"
    FAILED = "failed"
    CANCELLED = "cancelled"


class PrecedentCategory(Enum):
    """?? 카테고리 ?거??""
    CIVIL_CONTRACT = "민사_계약?해"
    CIVIL_PROPERTY = "민사_물권"
    CIVIL_FAMILY = "민사_가족법"
    CRIMINAL = "?사"
    ADMINISTRATIVE = "?정"
    COMMERCIAL = "?사?
    LABOR = "?동?
    INTELLECTUAL_PROPERTY = "지?재?권"
    CONSUMER = "?비?법"
    ENVIRONMENT = "?경?
    OTHER = "기?"


@dataclass
class CollectionStats:
    """?집 ?계 ?이???래??""
    start_time: datetime = field(default_factory=datetime.now)
    end_time: Optional[datetime] = None
    target_count: int = 5000
    collected_count: int = 0
    saved_count: int = 0
    duplicate_count: int = 0
    failed_count: int = 0
    keywords_processed: int = 0
    total_keywords: int = 0
    api_requests_made: int = 0
    api_errors: int = 0
    status: CollectionStatus = CollectionStatus.PENDING
    
    @property
    def success_rate(self) -> float:
        """?공?계산"""
        total_attempts = self.collected_count + self.duplicate_count + self.failed_count
        return (self.collected_count / total_attempts * 100) if total_attempts > 0 else 0.0
    
    @property
    def duration(self) -> Optional[timedelta]:
        """?집 ?요 ?간"""
        if self.end_time:
            return self.end_time - self.start_time
        return None


@dataclass
class PrecedentData:
    """?? ?이???래??""
    precedent_id: str
    case_name: str
    case_number: str
    court: str
    case_type: str
    decision_date: str
    category: PrecedentCategory
    raw_data: Dict[str, Any]
    detail_info: Dict[str, Any] = field(default_factory=dict)
    collected_at: datetime = field(default_factory=datetime.now)
    
    def __post_init__(self):
        """?이??검?""
        if not self.precedent_id:
            raise ValueError("?? ID???수?니??)
        if not self.case_name:
            raise ValueError("?건명? ?수?니??)
    
    @property
    def hash_id(self) -> str:
        """?? ?이?의 ?시 ID ?성"""
        import hashlib
        content = f"{self.precedent_id}_{self.case_name}_{self.case_number}"
        return hashlib.md5(content.encode('utf-8')).hexdigest()


# 검???워??(법률 분야? - 최적??버전
SEARCH_KEYWORDS = [
    # 민사?(기존 + ?장) - 고효???워???선
    "계약", "?해배상", "불법?위", "?유?, "?유?, "?치?, "??권", "질권",
    "???, "매매", "증여", "?속", "?언", "?인", "?혼", "친자관?,
    "채권", "채무", "?행", "지??, "?자", "?약?, "?제", "??", 
    "무효", "취소", "취득?효", "?멸?효", "?보", "보증", "??",
    
    # 추? 고효???워??(??가 많? ?워??
    "?건", "?송", "?판", "?결", "?정", "기판??, "?송?, "?사??,
    "?고", "?고", "??", "?고", "?심", "집행", "강제집행", "가?류",
    "가처분", "보전처분", "가?금", "과태?, "벌금", "??, "징역", "금고",
    "채권??, "채무??, "채권?도", "채무?수", "?계", "공탁", "?류", "가?류",
    
    # ?사?(기존 + ?장)
    "?도", "강도", "?기", "?령", "배임", "강간", "강제추행", "?인", "?해",
    "교통?고", "?주?전", "마약", "?박", "??", "?박", "강요",
    "?도?, "강도?, "?기?, "?령?, "배임?, "강간?, "강제추행?, 
    "?인?, "?해?, "교통?고처리???, "?로교통?, "???, "경범?,
    "보안관찰법", "보호관?, "가?방", "집행?예", "?고?예", "?의?효", "?의?멸",
    "공범", "교사?, "방조?, "미수?, "기수?, "?비?모", "?모",
    
    # ?정?(기존 + ?장)
    "?정처분", "??", "??", "?고", "?청", "?의?청", "?정?판", "?정?송",
    "?", "지방세", "부?산?기", "건축??", "?경?향??",
    "?정?차", "?정규칙", "?정지??, "?정계획", "?정계약", "?정???해배상", 
    "??배상", "?실보상", "?정??강제집행", "?정?, "과태?, "과징?,
    "?정??즉시강제", "?정???집행", "?정??강제징수", "?정??강제집행",
    "?정??강제징수", "?정??강제집행", "?정??강제징수", "?정??강제집행",
    
    # ?사?(기존 + ?장)
    "?사", "주식", "주주", "?사", "감사", "?병", "분할", "?산", "?",
    "?음", "?표", "보험", "?상", "??", "?송",
    "?한?사", "?명?사", "?자?사", "?한책임?사", "?호", "?호?, 
    "?호권침??, "?호권침?금지", "?호권침?금지?", "?호권침?금지??,
    "?호권침?금지?권의 ?사", "?호권침?금지?권의 ?사방법",
    "?호권침?금지?권의 ?사?건", "?호권침?금지?권의 ?사?과",
    "?호권침?금지?권의 ?사?한", "?호권침?금지?권의 ?사기간",
    
    # ?동?(기존 + ?장)
    "근로계약", "?금", "근로?간", "?게?간", "?일", "?차?급??", "?고",
    "?직?, "?업?해", "?업?전", "?동조합", "?체교섭", "?업",
    "근로??, "?용??, "근로조건", "근로기?", "근로기??, "근로기?법위?,
    "근로기?법위반죄", "근로기?법위반처?, "근로기?법위반처벌법",
    "근로기?법위반처벌법?반", "근로기?법위반처벌법?반?,
    "근로기?법위반처벌법?반처벌", "근로기?법위반처벌법?반처벌?,
    "근로기?법위반처벌법?반처벌법위?, "근로기?법위반처벌법?반처벌법위반죄",
    
    # 지?재?권?(기존 + ?장)
    "?허", "?용?안", "?자??, "?표", "??권", "?업비?", "부?경??,
    "?이?스", "기술?전", "발명", "창작?,
    "?허?, "?용?안?, "?자?권", "?표?, "??권", "?업비??, 
    "부?경?방지", "부?경?방지?, "부?경?방지법위?, "부?경?방지법위반죄",
    "부?경?방지법위반처?, "부?경?방지법위반처벌법", "부?경?방지법위반처벌법?반",
    "부?경?방지법위반처벌법?반?, "부?경?방지법위반처벌법?반처벌",
    "부?경?방지법위반처벌법?반처벌?, "부?경?방지법위반처벌법?반처벌법위?,
    
    # ?비?법 (기존 + ?장)
    "?비??, "계약", "??", "?시광고", "??거래", "방문?매", "?단계판?,
    "?신?매", "?자?거??, "개인?보", "?보공개",
    "?비?기본법", "?비?기본법?반", "?비?기본법?반?, "?비?기본법?반처벌",
    "?비?기본법?반처벌?, "?비?기본법?반처벌법위?, "?비?기본법?반처벌법위반죄",
    "?비?기본법?반처벌법위반처?, "?비?기본법?반처벌법위반처벌법",
    "?비?기본법?반처벌법위반처벌법?반", "?비?기본법?반처벌법위반처벌법?반?,
    "?비?기본법?반처벌법위반처벌법?반처벌", "?비?기본법?반처벌법위반처벌법?반처벌?,
    
    # ?경?(기존 + ?장)
    "?경", "??, "?질", "?양", "?음", "진동", "?취", "?기?,
    "?경?향??", "?경?염", "?태?, "?연?경",
    "?경?책", "?경?책기본?, "?경?책기본법위?, "?경?책기본법위반죄",
    "?경?책기본법위반처?, "?경?책기본법위반처벌법", "?경?책기본법위반처벌법?반",
    "?경?책기본법위반처벌법?반?, "?경?책기본법위반처벌법?반처벌",
    "?경?책기본법위반처벌법?반처벌?, "?경?책기본법위반처벌법?반처벌법위?,
    "?경?책기본법위반처벌법?반처벌법위반죄", "?경?책기본법위반처벌법?반처벌법위반처?,
    
    # 가족법 (?규 추?)
    "가?, "가족법", "가족??, "가족?계등?, "가족?계등록법", "가족?계등록법?반",
    "가족?계등록법?반?, "가족?계등록법?반처벌", "가족?계등록법?반처벌?,
    "가족?계등록법?반처벌법위?, "가족?계등록법?반처벌법위반죄",
    "가족?계등록법?반처벌법위반처?, "가족?계등록법?반처벌법위반처벌법",
    
    # 부?산?(?규 추?)
    "부?산", "부?산?, "부?산?기", "부?산?기?, "부?산?기법위?,
    "부?산?기법위반죄", "부?산?기법위반처?, "부?산?기법위반처벌법",
    "부?산?기법위반처벌법?반", "부?산?기법위반처벌법?반?,
    "부?산?기법위반처벌법?반처벌", "부?산?기법위반처벌법?반처벌?,
    
    # 금융?(?규 추?)
    "금융", "금융?, "금융거래", "금융거래?, "금융거래법위?, "금융거래법위반죄",
    "금융거래법위반처?, "금융거래법위반처벌법", "금융거래법위반처벌법?반",
    "금융거래법위반처벌법?반?, "금융거래법위반처벌법?반처벌",
    "금융거래법위반처벌법?반처벌?, "금융거래법위반처벌법?반처벌법위?,
    
    # ?료?(?규 추?)
    "?료", "?료?, "?료?고", "?료?고처리", "?료?고처리?, "?료?고처리법위?,
    "?료?고처리법위반죄", "?료?고처리법위반처?, "?료?고처리법위반처벌법",
    "?료?고처리법위반처벌법?반", "?료?고처리법위반처벌법?반?,
    "?료?고처리법위반처벌법?반처벌", "?료?고처리법위반처벌법?반처벌?,
    
    # 교육?(?규 추?)
    "교육", "교육?, "교육기본?, "교육기본법위?, "교육기본법위반죄",
    "교육기본법위반처?, "교육기본법위반처벌법", "교육기본법위반처벌법?반",
    "교육기본법위반처벌법?반?, "교육기본법위반처벌법?반처벌",
    "교육기본법위반처벌법?반처벌?, "교육기본법위반처벌법?반처벌법위?,
    
    # ?회보장?(?규 추?)
    "?회보장", "?회보장?, "?회보장기본?, "?회보장기본법위?, "?회보장기본법위반죄",
    "?회보장기본법위반처?, "?회보장기본법위반처벌법", "?회보장기본법위반처벌법?반",
    "?회보장기본법위반처벌법?반?, "?회보장기본법위반처벌법?반처벌",
    "?회보장기본법위반처벌법?반처벌?, "?회보장기본법위반처벌법?반처벌법위?
]

# ?선?위 ?워??(중요???? - ?장 버전
PRIORITY_KEYWORDS = [
    # 1?위: ?심 민사??워??(100?
    "계약", "?해배상", "불법?위", "?유?, "?유?, "채권", "채무", "?행",
    
    # 2?위: 주요 ?사??워??(80?
    "?기", "?도", "강도", "교통?고", "?주?전", "?도?, "강도?, "?기?,
    
    # 3?위: ?정??워??(60?
    "?정처분", "??", "??", "?", "지방세", "?정?차", "??배상", "?실보상",
    
    # 4?위: ?사??워??(50?
    "?사", "주식", "주주", "?사", "?병", "?한?사", "?명?사", "?호",
    
    # 5?위: ?동??워??(40?
    "근로계약", "?금", "?고", "?직?, "?업?해", "근로??, "?용??, "근로조건",
    
    # 6?위: 지?재?권??워??(30?
    "?허", "??권", "?표", "?업비?", "부?경??, "?허?, "?용?안?, "?자?권",
    
    # 7?위: ?비?법 ?워??(25?
    "?비??, "??", "?시광고", "??거래", "?자?거??, "?비?기본법", "개인?보", "?보공개",
    
    # 8?위: ?경??워??(20?
    "?경", "??, "?질", "?기?, "?경?향??", "?경?책", "?경?염", "?태?,
    
    # 9?위: 가족법 ?워??(15?
    "가?, "가족법", "가족??, "가족?계등?, "?인", "?혼", "친자관?, "?속",
    
    # 10?위: 부?산??워??(15?
    "부?산", "부?산?, "부?산?기", "부?산?기?, "???, "매매", "증여", "?언",
    
    # 11?위: 금융??워??(15?
    "금융", "금융?, "금융거래", "금융거래?, "?음", "?표", "보험", "?상",
    
    # 12?위: ?료??워??(15?
    "?료", "?료?, "?료?고", "?료?고처리", "?료?고처리?, "?료?고처리법위?,
    
    # 13?위: 교육??워??(15?
    "교육", "교육?, "교육기본?, "교육기본법위?, "교육기본법위반죄",
    
    # 14?위: ?회보장??워??(15?
    "?회보장", "?회보장?, "?회보장기본?, "?회보장기본법위?, "?회보장기본법위반죄"
]

# ?워?별 ?집 목표 건수 (?선?위???라 차등) - 2?증? 버전
KEYWORD_TARGET_COUNTS = {
    # 1?위: 240?(?심 민사?- 2?증?)
    "계약": 240, "?해배상": 240, "불법?위": 240, "?유?: 240, "?유?: 240,
    "채권": 240, "채무": 240, "?행": 240,
    
    # 1.5?위: 200?(고효???워??- 2?증?)
    "?건": 200, "?송": 200, "?판": 200, "?결": 200, "?정": 200,
    "?고": 200, "?고": 200, "??": 200, "?고": 200,
    
    # 2?위: 180?(주요 ?사?- 2?증?)
    "?기": 180, "?도": 180, "강도": 180, "교통?고": 180, "?주?전": 180,
    "?도?: 180, "강도?: 180, "?기?: 180,
    
    # 3?위: 120?(?정?- 2?증?)
    "?정처분": 120, "??": 120, "??": 120, "?": 120, "지방세": 120,
    "?정?차": 120, "??배상": 120, "?실보상": 120,
    
    # 4?위: 100?(?사?- 2?증?)
    "?사": 100, "주식": 100, "주주": 100, "?사": 100, "?병": 100,
    "?한?사": 100, "?명?사": 100, "?호": 100,
    
    # 5?위: 80?(?동?- 2?증?)
    "근로계약": 80, "?금": 80, "?고": 80, "?직?: 80, "?업?해": 80,
    "근로??: 80, "?용??: 80, "근로조건": 80,
    
    # 6?위: 60?(지?재?권?- 2?증?)
    "?허": 60, "??권": 60, "?표": 60, "?업비?": 60, "부?경??: 60,
    "?허?: 60, "?용?안?: 60, "?자?권": 60,
    
    # 7?위: 50?(?비?법 - 2?증?)
    "?비??: 50, "??": 50, "?시광고": 50, "??거래": 50, "?자?거??: 50,
    "?비?기본법": 50, "개인?보": 50, "?보공개": 50,
    
    # 8?위: 40?(?경?- 2?증?)
    "?경": 40, "??: 40, "?질": 40, "?기?: 40, "?경?향??": 40,
    "?경?책": 40, "?경?염": 40, "?태?: 40,
    
    # 9?위: 30?(가족법 - 2?증?)
    "가?: 30, "가족법": 30, "가족??: 30, "가족?계등?: 30,
    "?인": 30, "?혼": 30, "친자관?: 30, "?속": 30,
    
    # 10?위: 30?(부?산?- 2?증?)
    "부?산": 30, "부?산?: 30, "부?산?기": 30, "부?산?기?: 30,
    "???: 30, "매매": 30, "증여": 30, "?언": 30,
    
    # 11?위: 30?(금융?- 2?증?)
    "금융": 30, "금융?: 30, "금융거래": 30, "금융거래?: 30,
    "?음": 30, "?표": 30, "보험": 30, "?상": 30,
    
    # 12?위: 30?(?료?- 2?증?)
    "?료": 30, "?료?: 30, "?료?고": 30, "?료?고처리": 30,
    "?료?고처리?: 30, "?료?고처리법위?: 30,
    
    # 13?위: 30?(교육?- 2?증?)
    "교육": 30, "교육?: 30, "교육기본?: 30, "교육기본법위?: 30,
    "교육기본법위반죄": 30,
    
    # 14?위: 30?(?회보장?- 2?증?)
    "?회보장": 30, "?회보장?: 30, "?회보장기본?: 30, "?회보장기본법위?: 30,
    "?회보장기본법위반죄": 30
}

# 기본 ?워?당 ?집 건수 (?선?위 ?워?? ?닌 경우) - 2?증?
DEFAULT_KEYWORD_COUNT = 50

# 백업 ?워??(?집??부족할 ???용)
FALLBACK_KEYWORDS = [
    # ?반?인 법률 ?어
    "법원", "법원??, "?사", "검??, "변?사", "법무??, "공증??,
    "법정", "법정공개", "법정비공?, "?판", "?리", "변?, "증인",
    "증거", "증거조사", "증거보전", "증거개시", "증거?청", "증거채택",
    "증거배제", "증거?력", "증명??, "?백", "진술", "진술거??,
    "진술조서", "진술??, "진술보조??, "진술보조?선??, "진술보조?선?권",
    
    # ?송 관???어
    "?송", "?송?, "?송?건", "?송?력", "?송?위", "?송?위?력",
    "?송??, "?송?리권", "?송?리인", "?송?리인?임", "?송?리인?임?,
    "?송비용", "?송비용부??, "?송비용?계", "?송비용?정", "?송비용집행",
    "?송보조", "?송보조??, "?송보조?선??, "?송보조?선?권",
    
    # ?결 관???어
    "?결", "?결??, "?결?본", "?결?본", "?결초본", "?결?정",
    "?결?정??, "?결기판??, "?결집행??, "?결집행", "?결집행명령",
    "?결집행명령?청", "?결집행명령?청?, "?결집행명령?청??,
    
    # ??/?고 관??
    "??", "????, "???유??, "???유", "??기간", "???기",
    "???기?, "???기권자", "???기권자?력", "???기권자?력?인",
    "?고", "?고??, "?고?유??, "?고?유", "?고기간", "?고?기",
    "?고?기?, "?고?기권자", "?고?기권자?력", "?고?기권자?력?인",
    
    # 집행 관??
    "집행", "집행?, "집행문???, "집행문??신?, "집행문??신?",
    "집행문??신?", "집행문??신???, "집행문??신??능??,
    "강제집행", "강제집행?청", "강제집행?청?, "강제집행?청권자",
    "강제집행?청??, "강제집행?청권자?력", "강제집행?청권자?력?인",
    
    # 가?류/가처분
    "가?류", "가?류?청", "가?류?청?, "가?류?청권자", "가?류?청??,
    "가?류?청권자?력", "가?류?청권자?력?인", "가?류?청권자?력?인?청",
    "가처분", "가처분?청", "가처분?청?, "가처분?청권자", "가처분?청??,
    "가처분?청권자?력", "가처분?청권자?력?인", "가처분?청권자?력?인?청",
    
    # 보전처분
    "보전처분", "보전처분?청", "보전처분?청?, "보전처분?청권자", "보전처분?청??,
    "보전처분?청권자?력", "보전처분?청권자?력?인", "보전처분?청권자?력?인?청",
    
    # 기? 법률 ?어
    "법령", "법규", "법규명령", "법규명령?반", "법규명령?반?,
    "법규명령?반죄처?, "법규명령?반죄처벌법", "법규명령?반죄처벌법?반",
    "법규명령?반죄처벌법?반?, "법규명령?반죄처벌법?반죄처?,
]

# 법원 코드
COURT_CODES = {
    "01": "?법원",
    "02": "고등법원", 
    "03": "지방법??,
    "04": "가?법??,
    "05": "?정법원"
}

# ?건?형 코드
CASE_TYPE_CODES = {
    "01": "민사",
    "02": "?사", 
    "03": "?정",
    "04": "가??,
    "05": "?별?
}
