# 가중치 설정 근거 및 적절성 판단 기준 분석

## 현재 상황

### 발견된 문제

1. **명확한 근거 부재**
   - 가중치 값에 대한 명확한 연구 기반이나 실험 결과가 없음
   - 주석에 "테스트용"이라고만 표시되어 있음
   - 법률 도메인 특성에 대한 일반적인 추정에 기반

2. **테스트 스크립트는 있으나 결과 없음**
   - `test_weight_combinations.py` 스크립트는 존재하지만
   - 실제 테스트 결과나 성능 메트릭이 저장되지 않음
   - 어떤 가중치가 최적인지 검증되지 않음

3. **다른 파일과의 불일치**
   - `search_result_processor.py`: hybrid_law = 0.3:0.7
   - `hybrid_search_engine_v2.py`: law_inquiry = 0.6:0.4
   - 같은 개념인데 다른 가중치 사용

---

## 현재 가중치 설정의 추정 근거

### 1. 법령 조회 (hybrid_law)

**현재 설정**: semantic: 0.3, keyword: 0.7

**추정 근거**:
- 법령 조문은 정확한 조문 번호 매칭이 중요
- 키워드 검색(정확한 매칭)이 의미적 검색보다 중요하다고 가정
- **문제**: 검색 점수가 높아도 키워드 매칭이 낮으면 점수 하락

**개선된 설정**: semantic: 0.45, keyword: 0.55

**개선 근거**:
- 검색 점수 보호를 위해 의미적 검색 가중치 증가
- 키워드 매칭이 낮아도 검색 점수가 높으면 문서는 관련성이 높음
- **하지만 여전히 추정에 기반**

### 2. 판례 검색 (hybrid_case)

**현재 설정**: semantic: 0.7, keyword: 0.3

**추정 근거**:
- 판례는 유사 사례를 찾는 것이 중요
- 의미적 검색이 키워드 검색보다 중요하다고 가정
- **상대적으로 합리적**

### 3. 일반 질문 (hybrid_general)

**현재 설정**: semantic: 0.5, keyword: 0.5

**추정 근거**:
- 균형이 중요하다는 일반적인 가정
- **가장 안전한 선택**

---

## 적절성 판단 기준 부재

### 현재 문제점

1. **정량적 평가 기준 없음**
   - 어떤 메트릭으로 가중치를 평가하는지 불명확
   - Avg Relevance? Keyword Coverage? 실제 답변 품질?

2. **A/B 테스트 결과 없음**
   - 여러 가중치 조합을 실제로 테스트한 결과가 없음
   - 어떤 가중치가 더 나은 답변을 생성하는지 검증되지 않음

3. **법률 도메인 특성에 대한 구체적 연구 없음**
   - 법령 조회에서 semantic vs keyword의 실제 중요도 비율이 얼마인지 불명확
   - 판례 검색에서도 마찬가지

---

## 권장 개선 방안

### 1. 즉시 적용 가능한 개선

#### A. 검색 점수 기반 동적 가중치 (이미 구현됨)
- 검색 점수가 높으면 semantic 가중치 증가
- 검색 점수가 낮으면 keyword 가중치 증가
- **근거**: 검색 점수 자체가 문서 관련성을 나타냄

#### B. 필터링 시 검색 시점 점수 우선 사용 (이미 구현됨)
- `final_weighted_score`가 낮아도 검색 점수가 높으면 사용
- **근거**: 검색 점수가 더 직접적인 관련성 지표

### 2. 중장기 개선 방안

#### A. 실제 테스트 기반 최적화

**테스트 설계**:
1. 다양한 질문 유형별 테스트 쿼리 수집
   - 법령 조회: 20-30개
   - 판례 검색: 20-30개
   - 일반 질문: 20-30개

2. 여러 가중치 조합 테스트
   - 법령 조회: semantic 0.2-0.6, keyword 0.4-0.8 (0.05 간격)
   - 판례 검색: semantic 0.5-0.9, keyword 0.1-0.5 (0.05 간격)
   - 일반 질문: semantic 0.3-0.7, keyword 0.3-0.7 (0.05 간격)

3. 평가 메트릭 정의
   - **답변 품질**: LLM 생성 답변의 정확성, 완전성
   - **소스 관련성**: 실제 사용된 문서의 관련성
   - **문서 활용률**: 검색된 문서 중 실제 사용된 비율
   - **사용자 만족도**: 실제 사용자 평가 (가능한 경우)

4. 결과 분석 및 최적 가중치 선택
   - 각 메트릭별로 최고 성능을 보이는 가중치 조합 선택
   - 메트릭 간 트레이드오프 고려

#### B. 법률 도메인 특성 연구

**연구 주제**:
1. 법령 조회에서 semantic vs keyword의 실제 중요도
   - 법령명/조문번호가 정확히 일치하는 경우
   - 유사 조문을 찾는 경우
   - 관련 조문을 찾는 경우

2. 판례 검색에서 semantic vs keyword의 실제 중요도
   - 사건명/법원이 정확히 일치하는 경우
   - 유사 사례를 찾는 경우
   - 관련 사례를 찾는 경우

3. 질문 유형별 최적 가중치
   - 법령 조회의 하위 유형별 차이
   - 판례 검색의 하위 유형별 차이

#### C. 적응형 가중치 시스템

**구현 방안**:
1. 질문 유형별 기본 가중치 설정
2. 검색 결과 품질에 따른 동적 조정
   - 검색 점수 분포
   - 키워드 매칭률
   - 문서 다양성
3. 사용자 피드백 기반 학습 (장기적)

---

## 현재 가중치의 합리성 평가

### 합리적인 부분

1. **판례 검색**: semantic 0.7, keyword 0.3
   - 판례는 유사 사례 찾기가 중요하므로 합리적
   - 다만 0.65:0.35로 약간 조정하는 것도 고려 가능

2. **일반 질문**: semantic 0.5, keyword 0.5
   - 균형이 중요하므로 합리적

3. **검색 점수 기반 동적 가중치**
   - 검색 점수가 높으면 semantic 가중치 증가
   - 이는 합리적이고 이미 구현됨

### 문제가 있는 부분

1. **법령 조회**: semantic 0.3, keyword 0.7
   - 키워드 가중치가 너무 높아서 검색 점수 하락 문제 발생
   - 0.45:0.55로 조정했지만 여전히 추정에 기반

2. **고정 가중치의 한계**
   - 모든 법령 조회 질문에 동일한 가중치 적용
   - 실제로는 질문에 따라 다를 수 있음

---

## 결론 및 권장사항

### 현재 상황

1. **가중치 설정이 경험적 추정에 기반**
   - 명확한 연구 기반이나 실험 결과 없음
   - 법률 도메인 특성에 대한 일반적인 가정에 기반

2. **적절성 판단 기준 부재**
   - 정량적 평가 기준이 없음
   - A/B 테스트 결과가 없음

3. **개선된 가중치는 문제 해결을 위한 임시 조치**
   - 검색 점수 보호를 위해 조정
   - 하지만 여전히 추정에 기반

### 권장사항

1. **단기**: 현재 개선된 가중치 유지
   - 검색 점수 기반 동적 가중치 활용
   - 필터링 시 검색 시점 점수 우선 사용

2. **중기**: 실제 테스트 기반 최적화
   - 다양한 질문 유형별 테스트 쿼리 수집
   - 여러 가중치 조합 A/B 테스트
   - 평가 메트릭 정의 및 측정

3. **장기**: 적응형 가중치 시스템 구축
   - 질문 유형별 기본 가중치 설정
   - 검색 결과 품질에 따른 동적 조정
   - 사용자 피드백 기반 학습

### 명확히 해야 할 점

**현재 가중치는 "최적"이 아니라 "합리적인 추정"입니다.**
- 실제 테스트를 통해 검증이 필요함
- 법률 도메인 특성에 대한 더 깊은 연구 필요
- 사용자 피드백을 통한 지속적인 개선 필요

