# 문서 필터링 및 신뢰도 조정 분석 보고서

## 검토 일시
2024년

## 수정 이력
- **2024년**: 점수 계산 문제 해결 및 필터링 로직 개선
  - **근본 원인 해결**: 검색 시점 점수(`relevance_score`) 우선 사용
  - `final_weighted_score` 계산 시 검색 점수가 높으면 키워드 매칭 점수 영향 완화
  - 벡터 필터링 임계값: 검색 점수 기반으로 동적 조정 (0.60-0.75)
  - 최소 문서 수 증가 (3개 → 5개)
  - 질문 유형별 최소 문서 수 차등화 (law_inquiry: 5개, simple_question: 2개 등)

---

## 1. 검색된 문서 수 vs 실제 사용 문서 수 분석

### 테스트 결과
- **검색된 문서**: 54개 (17 + 7 + 10 + 10 + 10)
- **실제 사용 문서**: 3개
- **문서 손실률**: 94.4% (51개 손실)

### 필터링 단계별 분석

#### 1단계: 내용 추출 및 검증 (`valid_docs_for_prompt`)
**위치**: `workflow_document_processor.py:278-334`

**필터링 기준**:
- 최소 내용 길이: 10자 이상
- 내용이 없거나 짧으면 제외

**예상 손실**: 중간 정도 (내용 없는 문서 제외)

#### 2단계: 관련성 점수 필터링 (`valid_docs`)
**위치**: `workflow_document_processor.py:349-461`

**필터링 기준**:
- 동적 임계값 계산 (평균 점수 기반)
- 문서 타입별 차등 임계값:
  - `statute_article`: 0.03-0.08 (매우 낮음)
  - `semantic`: 0.05-0.10
  - `keyword`: 0.05-0.10
  - `precedent`: 0.05-0.10
  - `general`: 0.08-0.15

**문제점**:
- 평균 점수가 낮으면 (0.20 미만) 임계값이 매우 낮게 설정됨
- 하지만 여전히 많은 문서가 필터링됨

#### 3단계: Keyword Coverage 필터링
**위치**: `workflow_document_processor.py:637-669`

**필터링 기준**:
- 문서가 10개 이하일 때는 **건너뜀** (문서 손실 방지)
- 10개 초과일 때만 필터링 수행

**예상 손실**: 없음 (10개 이하일 때는 건너뜀)

#### 4단계: 벡터 결과 관련성 점수 필터링 (CRITICAL)
**위치**: `workflow_document_processor.py:697-832`

**필터링 기준**:
```python
# 동적 임계값 계산: 평균 점수의 80% 또는 최소 0.60
dynamic_threshold = max(0.60, min(0.75, avg_score * 0.8))

# 점수 분포가 낮으면 임계값 완화
if avg_score < 0.70:
    dynamic_threshold = max(0.50, avg_score * 0.7)

# statute_article 타입은 더 낮은 임계값 적용
statute_threshold = max(0.40, dynamic_threshold * 0.8)
```

**문제점 발견**:
1. **임계값이 너무 높음**: 최소 0.60 (60%)
   - 검색 점수가 0.98이어도, 재랭킹 후 점수가 낮을 수 있음
   - `final_weighted_score`가 낮으면 필터링됨

2. **검증 단계가 너무 엄격**:
   - 메타데이터 검증
   - 내용 품질 검증
   - 출처 신뢰도 검증
   - 모든 검증을 통과해야만 포함됨

3. **최소 문서 수 보장이 부족**:
   - 최소 3개 보장 로직이 있지만, 검증 실패 시 보장되지 않음

#### 5단계: `select_balanced_documents` 최종 선택
**위치**: `workflow_document_processor.py:1431-1738`

**필터링 기준**:
- `max_docs=10` (기본값)
- 의미적 검색과 키워드 검색 결과의 균형 유지

**예상 손실**: 중간 정도 (균형 유지 과정에서 일부 손실)

---

## 2. 주요 문제점

### 문제 1: 벡터 결과 관련성 점수 필터링이 너무 엄격 (CRITICAL)

**현재 로직**:
```python
dynamic_threshold = max(0.60, min(0.75, avg_score * 0.8))
```

**문제**:
- 최소 임계값이 0.60 (60%)으로 너무 높음
- 검색 점수가 높아도 재랭킹 후 점수가 낮으면 필터링됨
- 검증 단계가 3단계로 너무 많음

**개선 방안**:
1. 동적 임계값을 더 낮춤 (0.40-0.50)
2. 검증 단계 완화 (최소 1개 통과하면 포함)
3. 최소 문서 수 보장 강화 (검증 실패해도 포함)

### 문제 2: 검증 단계가 너무 엄격

**현재 로직**:
- 메타데이터 검증
- 내용 품질 검증
- 출처 신뢰도 검증
- **모든 검증을 통과해야만 포함**

**문제**:
- 하나라도 실패하면 제외됨
- 검증 기준이 너무 엄격할 수 있음

**개선 방안**:
- 검증 실패해도 최소 문서 수 보장
- 검증 기준 완화

### 문제 3: 최소 문서 수 보장이 불충분

**현재 로직**:
- 최소 3개 보장 시도
- 하지만 검증 실패 시 보장되지 않음

**개선 방안**:
- 검증 실패해도 최소 문서 수 보장
- 임계값을 점진적으로 낮춰가며 포함

---

## 3. 질문 유형별 신뢰도 조정 검토

### 현재 신뢰도 계산 로직

**위치**: `confidence_calculator.py:65-98`

**가중치**:
- `answer_length`: 10%
- `source_quality`: 25%
- `question_type`: 20%
- `answer_quality`: 35%
- `source_count`: 10%

**질문 유형별 신뢰도 계산**:
```python
factors['question_type'] = self._calculate_type_confidence(question_type)
```

### 질문 유형별 최소 신뢰도

**위치**: `answer_formatter.py:1007`

```python
min_confidence_by_type = {
    "law_inquiry": 0.80,      # 법령 조회: 높은 신뢰도 요구
    "case_inquiry": 0.75,     # 판례 조회: 높은 신뢰도 요구
    "complex_question": 0.70, # 복잡한 질문: 중간 신뢰도
    "general": 0.70,          # 일반 질문: 중간 신뢰도
    "greeting": 0.50,         # 인사: 낮은 신뢰도 허용
    "simple_question": 0.65   # 간단한 질문: 낮은 신뢰도 허용
}
```

### 검토 결과

#### ✅ 현재 구현이 적절함

1. **질문 유형별 차등 적용**: 이미 구현되어 있음
   - 법령/판례 조회: 높은 신뢰도 요구 (0.75-0.80)
   - 일반 질문: 중간 신뢰도 (0.70)
   - 인사: 낮은 신뢰도 허용 (0.50)

2. **가중치 배분이 합리적**:
   - 답변 품질: 35% (가장 중요)
   - 소스 품질: 25% (중요)
   - 질문 유형: 20% (적절)

#### ⚠️ 개선 가능 사항

1. **질문 유형별 신뢰도 조정 강화**:
   - 현재는 최소 신뢰도만 설정
   - 질문 유형에 따라 신뢰도 계산 가중치도 조정 가능

2. **복잡도 기반 조정**:
   - `complex_question`의 경우 더 많은 문서 필요
   - 문서 수에 따른 신뢰도 보정 추가

---

## 4. 권장 개선 사항

### 즉시 개선 (High Priority)

#### 1. 벡터 결과 관련성 점수 필터링 완화
```python
# 현재
dynamic_threshold = max(0.60, min(0.75, avg_score * 0.8))

# 개선
dynamic_threshold = max(0.40, min(0.65, avg_score * 0.7))  # 더 낮은 임계값
```

#### 2. 검증 단계 완화
```python
# 현재: 모든 검증 통과 필요
# 개선: 최소 1개 통과하면 포함, 최소 문서 수 보장
```

#### 3. 최소 문서 수 보장 강화
```python
# 검증 실패해도 최소 문서 수 보장
# 임계값을 점진적으로 낮춰가며 포함
```

### 중기 개선 (Medium Priority)

#### 1. 질문 유형별 필터링 기준 차등화
- `law_inquiry`: 더 많은 문서 포함 (법령 조회는 정확성 중요)
- `complex_question`: 더 많은 문서 포함 (복잡한 질문은 다양한 관점 필요)
- `simple_question`: 적은 문서로도 충분

#### 2. 문서 수에 따른 신뢰도 보정
- 문서가 많을수록 신뢰도 증가
- 문서가 적을수록 신뢰도 감소 (하지만 최소 기준 유지)

---

## 5. 결론

### 문서 필터링 문제
- **주요 원인**: 벡터 결과 관련성 점수 필터링이 너무 엄격 (임계값 0.60)
- **해결 방향**: 임계값 완화 (0.40-0.50), 검증 단계 완화, 최소 문서 수 보장 강화

### 질문 유형별 신뢰도 조정
- **현재 상태**: 이미 구현되어 있음 (질문 유형별 최소 신뢰도 차등 적용)
- **개선 가능**: 질문 유형별 필터링 기준 차등화, 문서 수에 따른 신뢰도 보정

