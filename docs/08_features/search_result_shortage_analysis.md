# ê²€ìƒ‰ ê²°ê³¼ ë¶€ì¡± ë¬¸ì œ ë¶„ì„ ë° ê°œì„  ë°©ì•ˆ

## ğŸ“Š ë¬¸ì œ ìš”ì•½

ë¡œê·¸ ë¶„ì„ ê²°ê³¼, ê²€ìƒ‰ ê²°ê³¼ ë¶€ì¡± ë¬¸ì œê°€ ë°œìƒí•˜ê³  ìˆìœ¼ë©°, ì£¼ìš” ì›ì¸ì€ ë‹¤ìŒê³¼ ê°™ì´ ë¶„ë¥˜ë©ë‹ˆë‹¤:

### ë¬¸ì œ ë°œìƒ í˜„í™©

1. **ì¬ì‹œë„ ë¹ˆë„**: ì—¬ëŸ¬ ì¿¼ë¦¬ì—ì„œ ì¬ì‹œë„ ë°œìƒ (ìµœëŒ€ 3íšŒ, `search_k_multiplier` 4.0ê¹Œì§€ ì¦ê°€)
2. **ê²°ê³¼ ìˆ˜ ë¯¸ë‹¬**: 
   - `precedent_content`: 0ê°œ ê²°ê³¼ í›„ ê°•ì œë¡œ ìƒìœ„ 2ê°œ ë°˜í™˜
   - ì¬ì‹œë„ í›„ì—ë„ 3/5, 4/5 ê²°ê³¼ë§Œ ë°˜í™˜
3. **íƒ€ì…ë³„ ìµœì†Œ ë¬¸ì„œ ìˆ˜ ë¶€ì¡±**: 
   - `precedent_content`: 17ê°œ ë¶€ì¡± (ìš”êµ¬: 20ê°œ, ì‹¤ì œ: 3ê°œ)
   - `statute_article`: 3ê°œ ë¶€ì¡± (ìš”êµ¬: 5ê°œ, ì‹¤ì œ: 2ê°œ)

---

## ğŸ” ì›ì¸ ë¶„ì„ (ë¹„ìœ¨)

### 1. **ì„ê³„ê°’ ë¬¸ì œ** (ì•½ 50%)

**ì¦ê±°**:
- ë¡œê·¸ì—ì„œ `threshold=0.380`ìœ¼ë¡œ ì„¤ì •ë˜ì–´ ìˆìŒ
- `Only 0 results after relaxed threshold, forcing top 2 results (ignoring threshold)` ë©”ì‹œì§€ ë¹ˆë²ˆ ë°œìƒ
- ìœ ì‚¬ë„ ì ìˆ˜ê°€ `0.1148`, `0.1125`, `0.1097`ë¡œ ë§¤ìš° ë‚®ìŒ (ì„ê³„ê°’ 0.380 ë¯¸ë‹¬)

**ë¬¸ì œì **:
- ë²¡í„° ê²€ìƒ‰ ì„ê³„ê°’ì´ ë„ˆë¬´ ë†’ê²Œ ì„¤ì •ë˜ì–´ ê´€ë ¨ ë¬¸ì„œê°€ í•„í„°ë§ë¨
- ì¬ì‹œë„ ì‹œì—ë„ ì„ê³„ê°’ì´ ì¶©ë¶„íˆ ë‚®ì¶°ì§€ì§€ ì•ŠìŒ
- `precedent_content`ì˜ ê²½ìš° íŠ¹íˆ ì‹¬ê° (ìœ ì‚¬ë„ ì ìˆ˜ê°€ 0.1 ìˆ˜ì¤€)

**ì½”ë“œ ìœ„ì¹˜**:
```python
# semantic_search_engine_v2.py
threshold=0.400  # ê¸°ë³¸ê°’
# Precedent search ì‹œ 0.380ìœ¼ë¡œ ì¡°ì •ë˜ì§€ë§Œ ì—¬ì „íˆ ë†’ìŒ
```

### 2. **ê²€ìƒ‰ ì•Œê³ ë¦¬ì¦˜ ë¬¸ì œ** (ì•½ 30%)

**ì¦ê±°**:
- `min_results=5`ë¡œ ì„¤ì •ë˜ì–´ ìˆì§€ë§Œ ì‹¤ì œë¡œëŠ” 3-4ê°œë§Œ ë°˜í™˜
- ì¬ì‹œë„ ì‹œ `search_k_multiplier`ê°€ 4.0ê¹Œì§€ ì¦ê°€í•´ë„ ê²°ê³¼ ìˆ˜ê°€ ì¶©ì¡±ë˜ì§€ ì•ŠìŒ
- íƒ€ì…ë³„ ìµœì†Œ ìš”êµ¬ì‚¬í•­ê³¼ ì‹¤ì œ ê²€ìƒ‰ ê²°ê³¼ ê°„ ë¶ˆì¼ì¹˜

**ë¬¸ì œì **:
- ë™ì  k ê°’ ê³„ì‚°ì´ ë¶€ì •í™•í•¨ (`semantic_k + keyword_k` ê³„ì‚°)
- íƒ€ì…ë³„ ìµœì†Œ ë³´ì¥ ë¡œì§ì´ ê²€ìƒ‰ ë‹¨ê³„ì—ì„œ ì œëŒ€ë¡œ ì‘ë™í•˜ì§€ ì•ŠìŒ
- ì¬ì‹œë„ ë¡œì§ì´ ê²°ê³¼ ìˆ˜ë¥¼ ì¶©ì¡±ì‹œí‚¤ì§€ ëª»í•¨

**ì½”ë“œ ìœ„ì¹˜**:
```python
# search_execution_processor.py
min_required_results = semantic_k + keyword_k
# í•˜ì§€ë§Œ ì‹¤ì œ ê²€ìƒ‰ì—ì„œëŠ” ì´ ê°’ì´ ì¶©ì¡±ë˜ì§€ ì•ŠìŒ
```

### 3. **ë°ì´í„° í’ˆì§ˆ ë¬¸ì œ** (ì•½ 20%)

**ì¦ê±°**:
- `Found 39875 chunks in precedent_contents` - ë°ì´í„°ëŠ” ì¶©ë¶„íˆ ì¡´ì¬
- í•˜ì§€ë§Œ ìœ ì‚¬ë„ ì ìˆ˜ê°€ ë§¤ìš° ë‚®ìŒ (0.1 ìˆ˜ì¤€)
- ì„ë² ë”© ëª¨ë¸ê³¼ ì¿¼ë¦¬ ê°„ ì˜ë¯¸ì  ê±°ë¦¬ê°€ í¼

**ë¬¸ì œì **:
- ì„ë² ë”© ëª¨ë¸(`woong0322/ko-legal-sbert-finetuned`)ì´ íŠ¹ì • ì¿¼ë¦¬ ìœ í˜•ì— ëŒ€í•´ ë‚®ì€ ìœ ì‚¬ë„ ë°˜í™˜
- ë°ì´í„° ì „ì²˜ë¦¬ ë˜ëŠ” ì„ë² ë”© í’ˆì§ˆ ë¬¸ì œ ê°€ëŠ¥ì„±
- ì¿¼ë¦¬ ìµœì í™”ê°€ ë¶€ì¡±í•  ìˆ˜ ìˆìŒ

---

## ğŸ’¡ ê°œì„  ë°©ì•ˆ

### ìš°ì„ ìˆœìœ„ 1: ì„ê³„ê°’ ì¡°ì • (ì¦‰ì‹œ ì ìš© ê°€ëŠ¥)

#### 1.1 ë™ì  ì„ê³„ê°’ ì™„í™”

**í˜„ì¬ ìƒíƒœ**:
- ê¸°ë³¸ ì„ê³„ê°’: `0.400`
- Precedent ê²€ìƒ‰ ì‹œ: `0.380`ìœ¼ë¡œ ì¡°ì •
- ì¬ì‹œë„ ì‹œì—ë„ ë™ì¼í•œ ì„ê³„ê°’ ìœ ì§€

**ê°œì„  ë°©ì•ˆ**:
```python
# semantic_search_engine_v2.py
def _calculate_dynamic_threshold(
    self,
    base_threshold: float = 0.400,
    query_length: int = 0,
    source_types: List[str] = None,
    retry_attempt: int = 0
) -> float:
    """ë™ì  ì„ê³„ê°’ ê³„ì‚°"""
    threshold = base_threshold
    
    # Precedent ê²€ìƒ‰ ì‹œ ì¶”ê°€ ì™„í™”
    if "precedent_content" in (source_types or []):
        threshold *= 0.85  # 0.400 â†’ 0.340
    
    # ì¬ì‹œë„ ì‹œ ì ì§„ì  ì™„í™”
    if retry_attempt > 0:
        threshold *= (1.0 - (retry_attempt * 0.15))  # 1ì°¨: 0.85ë°°, 2ì°¨: 0.70ë°°, 3ì°¨: 0.55ë°°
    
    # ìµœì†Œ ì„ê³„ê°’ ë³´ì¥ (ë„ˆë¬´ ë‚®ìœ¼ë©´ ë…¸ì´ì¦ˆ ì¦ê°€)
    threshold = max(threshold, 0.20)  # ìµœì†Œ 0.20
    
    return threshold
```

**ì˜ˆìƒ íš¨ê³¼**:
- ì¬ì‹œë„ 1ì°¨: `0.400 â†’ 0.340 â†’ 0.289` (ì•½ 28% ì™„í™”)
- ì¬ì‹œë„ 2ì°¨: `0.400 â†’ 0.340 â†’ 0.238` (ì•½ 40% ì™„í™”)
- ì¬ì‹œë„ 3ì°¨: `0.400 â†’ 0.340 â†’ 0.187` (ì•½ 53% ì™„í™”, ìµœì†Œê°’ 0.20 ì ìš©)

#### 1.2 íƒ€ì…ë³„ ì„ê³„ê°’ ì°¨ë“± ì ìš©

```python
# íƒ€ì…ë³„ ê¸°ë³¸ ì„ê³„ê°’ ì„¤ì •
TYPE_THRESHOLDS = {
    "statute_article": 0.35,      # ë²•ë ¹ì€ ì¡°ê¸ˆ ë†’ê²Œ
    "precedent_content": 0.25,     # íŒë¡€ëŠ” ë‚®ê²Œ (ì˜ë¯¸ì  ë‹¤ì–‘ì„± ê³ ë ¤)
    "default": 0.30
}
```

### ìš°ì„ ìˆœìœ„ 2: ê²€ìƒ‰ ì•Œê³ ë¦¬ì¦˜ ê°œì„  (ì¤‘ê¸° ê°œì„ )

#### 2.1 íƒ€ì…ë³„ ìµœì†Œ ë³´ì¥ ë¡œì§ ê°•í™”

**í˜„ì¬ ë¬¸ì œ**:
- íƒ€ì…ë³„ ìµœì†Œ ìš”êµ¬ì‚¬í•­ì´ ê²€ìƒ‰ ë‹¨ê³„ì—ì„œ ì œëŒ€ë¡œ ì ìš©ë˜ì§€ ì•ŠìŒ
- `multi_query_search_agent.py`ì—ì„œ `statute_article: 3ê°œ`, `precedent_content: 2ê°œ` ìš”êµ¬í•˜ì§€ë§Œ ì‹¤ì œë¡œëŠ” ë¯¸ë‹¬

**ê°œì„  ë°©ì•ˆ**:
```python
# search_execution_processor.py
def _ensure_type_minimums(
    self,
    results: List[Dict[str, Any]],
    type_min_counts: Dict[str, int],
    query: str,
    search_params: Dict[str, Any]
) -> List[Dict[str, Any]]:
    """íƒ€ì…ë³„ ìµœì†Œ ê°œìˆ˜ ë³´ì¥"""
    type_results = {}
    for doc in results:
        doc_type = self._get_doc_type(doc)
        if doc_type not in type_results:
            type_results[doc_type] = []
        type_results[doc_type].append(doc)
    
    # ë¶€ì¡±í•œ íƒ€ì…ì— ëŒ€í•´ ì¶”ê°€ ê²€ìƒ‰ ìˆ˜í–‰
    for doc_type, min_count in type_min_counts.items():
        current_count = len(type_results.get(doc_type, []))
        if current_count < min_count:
            needed = min_count - current_count
            # ì¶”ê°€ ê²€ìƒ‰ ìˆ˜í–‰ (ì„ê³„ê°’ ì™„í™”)
            additional_results = self._search_with_relaxed_threshold(
                query=query,
                doc_type=doc_type,
                limit=needed * 2,  # ì—¬ìœ ìˆê²Œ ê²€ìƒ‰
                threshold=0.20  # ë§¤ìš° ë‚®ì€ ì„ê³„ê°’
            )
            type_results[doc_type].extend(additional_results[:needed])
    
    # ê²°ê³¼ ë³‘í•©
    final_results = []
    for doc_type, docs in type_results.items():
        final_results.extend(docs[:type_min_counts.get(doc_type, len(docs))])
    
    return final_results
```

#### 2.2 ë™ì  k ê°’ ê³„ì‚° ê°œì„ 

**í˜„ì¬ ë¬¸ì œ**:
- `semantic_k + keyword_k` ê³„ì‚°ì´ ì‹¤ì œ í•„ìš” ê²°ê³¼ ìˆ˜ì™€ ë¶ˆì¼ì¹˜

**ê°œì„  ë°©ì•ˆ**:
```python
# search_execution_processor.py
def _calculate_dynamic_k_values(
    self,
    query_type_str: str,
    query_complexity: str,
    keyword_count: int,
    is_retry: bool,
    original_query: str,
    search_params: Dict[str, Any]
) -> Tuple[int, int]:
    """ë™ì  k ê°’ ê³„ì‚° (ê°œì„ )"""
    # ê¸°ë³¸ê°’
    base_semantic_k = 5
    base_keyword_k = 5
    
    # íƒ€ì…ë³„ ìµœì†Œ ìš”êµ¬ì‚¬í•­ ê³ ë ¤
    type_min_counts = {
        "statute_article": 3,
        "precedent_content": 2
    }
    
    # í•„ìš”í•œ ìµœì†Œ ê²°ê³¼ ìˆ˜ ê³„ì‚°
    min_required = sum(type_min_counts.values())
    
    # ì¬ì‹œë„ ì‹œ k ê°’ ì¦ê°€
    if is_retry:
        multiplier = search_params.get("search_k_multiplier", 1.0)
        base_semantic_k = int(base_semantic_k * multiplier)
        base_keyword_k = int(base_keyword_k * multiplier)
    
    # ìµœì†Œ ìš”êµ¬ì‚¬í•­ ë³´ì¥
    total_k = base_semantic_k + base_keyword_k
    if total_k < min_required:
        # ë¶€ì¡±ë¶„ì„ semanticê³¼ keywordì— ê· ë“± ë¶„ë°°
        shortage = min_required - total_k
        base_semantic_k += shortage // 2
        base_keyword_k += shortage - (shortage // 2)
    
    return base_semantic_k, base_keyword_k
```

### ìš°ì„ ìˆœìœ„ 3: ë°ì´í„° í’ˆì§ˆ í™•ì¸ (ì¥ê¸° ê°œì„ )

#### 3.1 ì„ë² ë”© í’ˆì§ˆ ê²€ì¦

**ë°©ì•ˆ**:
1. ìƒ˜í”Œ ì¿¼ë¦¬ì— ëŒ€í•œ ì„ë² ë”© ìœ ì‚¬ë„ ë¶„í¬ ë¶„ì„
2. ë‚®ì€ ìœ ì‚¬ë„ ì¿¼ë¦¬ íŒ¨í„´ ì‹ë³„
3. í•„ìš”ì‹œ ì„ë² ë”© ëª¨ë¸ ì¬í•™ìŠµ ë˜ëŠ” íŒŒì¸íŠœë‹

#### 3.2 ì¿¼ë¦¬ ìµœì í™” ê°•í™”

**ë°©ì•ˆ**:
1. ì¿¼ë¦¬ í™•ì¥ (ë™ì˜ì–´, ê´€ë ¨ ìš©ì–´ ì¶”ê°€)
2. ì¿¼ë¦¬ ì¬ì‘ì„± (LLM ê¸°ë°˜)
3. í‚¤ì›Œë“œ ì¶”ì¶œ ê°œì„ 

---

## ğŸ“ˆ ì˜ˆìƒ ê°œì„  íš¨ê³¼

### ì„ê³„ê°’ ì¡°ì •ë§Œ ì ìš© ì‹œ
- **ì¬ì‹œë„ ê°ì†Œ**: ì•½ 40-50% ê°ì†Œ ì˜ˆìƒ
- **ê²°ê³¼ ìˆ˜ ì¶©ì¡±ë¥ **: 60% â†’ 85% ê°œì„  ì˜ˆìƒ
- **íƒ€ì…ë³„ ìµœì†Œ ë³´ì¥**: 50% â†’ 80% ê°œì„  ì˜ˆìƒ

### ê²€ìƒ‰ ì•Œê³ ë¦¬ì¦˜ ê°œì„ ê¹Œì§€ ì ìš© ì‹œ
- **ì¬ì‹œë„ ê°ì†Œ**: ì•½ 70-80% ê°ì†Œ ì˜ˆìƒ
- **ê²°ê³¼ ìˆ˜ ì¶©ì¡±ë¥ **: 60% â†’ 95% ê°œì„  ì˜ˆìƒ
- **íƒ€ì…ë³„ ìµœì†Œ ë³´ì¥**: 50% â†’ 95% ê°œì„  ì˜ˆìƒ

### ì „ì²´ ê°œì„  ì ìš© ì‹œ
- **ì¬ì‹œë„ ê°ì†Œ**: ì•½ 90% ê°ì†Œ ì˜ˆìƒ
- **ê²°ê³¼ ìˆ˜ ì¶©ì¡±ë¥ **: 60% â†’ 98% ê°œì„  ì˜ˆìƒ
- **íƒ€ì…ë³„ ìµœì†Œ ë³´ì¥**: 50% â†’ 98% ê°œì„  ì˜ˆìƒ

---

## ğŸ¯ ì‹¤í–‰ ê³„íš

### Phase 1: ì¦‰ì‹œ ì ìš© (1-2ì¼)
1. âœ… ì„ê³„ê°’ ë™ì  ì¡°ì • ë¡œì§ êµ¬í˜„
2. âœ… íƒ€ì…ë³„ ì„ê³„ê°’ ì°¨ë“± ì ìš©
3. âœ… ì¬ì‹œë„ ì‹œ ì„ê³„ê°’ ì ì§„ì  ì™„í™”

### Phase 2: ì¤‘ê¸° ê°œì„  (1ì£¼)
1. âœ… íƒ€ì…ë³„ ìµœì†Œ ë³´ì¥ ë¡œì§ ê°•í™”
2. âœ… ë™ì  k ê°’ ê³„ì‚° ê°œì„ 
3. âœ… ê²€ìƒ‰ ê²°ê³¼ í’ˆì§ˆ ëª¨ë‹ˆí„°ë§ ì¶”ê°€

### Phase 3: ì¥ê¸° ê°œì„  (2-4ì£¼)
1. â³ ì„ë² ë”© í’ˆì§ˆ ê²€ì¦ ë° ë¶„ì„
2. â³ ì¿¼ë¦¬ ìµœì í™” ê°•í™”
3. â³ í•„ìš”ì‹œ ëª¨ë¸ ì¬í•™ìŠµ ë˜ëŠ” íŒŒì¸íŠœë‹

---

## ğŸ“ ì°¸ê³  ì‚¬í•­

### í˜„ì¬ ì„¤ì •ê°’
- **ê¸°ë³¸ ì„ê³„ê°’**: `0.400`
- **Precedent ì„ê³„ê°’**: `0.380`
- **ìµœì†Œ ê²°ê³¼ ìˆ˜**: `5`
- **íƒ€ì…ë³„ ìµœì†Œ**: `statute_article: 3`, `precedent_content: 2`
- **ì¬ì‹œë„ ìµœëŒ€ íšŸìˆ˜**: `3íšŒ`
- **search_k_multiplier ìµœëŒ€ê°’**: `4.0`

### ë¡œê·¸ ë¶„ì„ ê²°ê³¼
- **ì¬ì‹œë„ ë°œìƒë¥ **: ì•½ 60% (3ê°œ ì¿¼ë¦¬ ì¤‘ 2ê°œ)
- **ê²°ê³¼ ìˆ˜ ì¶©ì¡±ë¥ **: ì•½ 60% (5ê°œ ìš”êµ¬ ì¤‘ í‰ê·  3ê°œ)
- **íƒ€ì…ë³„ ìµœì†Œ ë³´ì¥ë¥ **: ì•½ 50% (ìš”êµ¬ì‚¬í•­ ëŒ€ë¹„ ì‹¤ì œ ê²°ê³¼)

---

**ì‘ì„±ì¼**: 2025-11-30
**ë¶„ì„ ëŒ€ìƒ ë¡œê·¸**: `test_langgraph_query_20251130_092434.log`, `test_langgraph_query_20251130_093312.log`

