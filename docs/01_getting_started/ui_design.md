# 법률 상담 챗봇 React 구현 기능 명세

## 1. 초기 화면 구성

### 1.1 웰컴 스크린 ✅ 구현 완료
- **빈 화면 상태 처리**: 대화 이력이 없을 때 중앙에 환영 메시지와 서비스 소개 표시
- **빠른 질문 카드**: 자주 묻는 법률 상담 주제를 카드 형태로 제공
  - **구현된 카테고리**:
    - 📄 계약 관련 (계약서 검토, 위약금, 계약 해제)
    - 🏠 임대차 분쟁 (임대차 분쟁, 전세금 반환, 임대차 보호법)
    - 💼 근로 관련 (근로계약, 퇴직금, 근로시간)
    - ⚖️ 손해배상 (손해배상 청구, 과실 상계, 배상 범위)
  - **2단계 선택 방식**: 카테고리 선택 → 세부 질문 선택
  - 클릭 시 해당 질문으로 자동 전송 및 새 세션 생성

## 2. 사이드바 구성 ✅ 구현 완료

### 2.1 상단 영역 - 세션 관리 ✅ 구현 완료
- **새 상담 시작 버튼**: 
  - 빨간색 프라이머리 버튼 (Plus 아이콘 포함)
  - 클릭 시 즉시 새 세션 생성
  - 현재 대화는 자동 저장됨
  - 로딩 상태 표시 (LoadingSpinner)

### 2.2 대화 히스토리 ✅ 구현 완료
- **히스토리 검색창**: 
  - 상단에 검색 입력 필드 (SearchBar 컴포넌트)
  - 실시간 필터링: 제목 기반 검색 (대소문자 구분 없음)
  - 검색어 입력 시 즉시 필터링
  
- **날짜별 그룹 리스트** ✅ 구현 완료:
  - **오늘**: 당일 대화 세션들 (기본 펼침)
  - **어제**: 전일 대화 세션들
  - **지난 7일**: 최근 일주일
  - **지난 30일**: 최근 한 달
  - **이전 대화**: 30일 이상 된 대화
  - 접기/펼치기 기능 (ChevronDown/ChevronRight 아이콘)
  - 그룹별 세션 개수 표시
  
- **세션 카드 구성** ✅ 구현 완료:
  - 세션 제목 (truncate 처리, 최대 1줄)
  - 메시지 개수 및 상대 시간 표시 (예: "12개 메시지 • 2시간 전")
  - 호버 시 메뉴 버튼 표시 (MoreVertical 아이콘)
  
- **세션 액션** ✅ 구현 완료:
  - 클릭: 해당 세션 불러오기
  - 호버 시 메뉴 버튼 클릭:
    - 이름 변경 (prompt 사용)
    - 복사본 만들기 (새 세션 생성)
    - 내보내기 (TXT 형식)
    - 삭제 (확인 다이얼로그)

### 2.3 사이드바 UX ✅ 구현 완료
- **접기/펼치기**: 
  - Header의 햄버거 메뉴 아이콘으로 토글
  - 사이드바 너비: 256px (w-64) / 0px (닫힘)
  - 펼친 상태 기본값
  - 부드러운 전환 애니메이션 (transition-all duration-300)

- **스크롤 영역 분리** ✅ 구현 완료:
  - 상단 버튼 고정 (border-b)
  - 히스토리 영역만 스크롤 (flex-1 overflow-y-auto)

## 3. 대화 인터페이스 ✅ 구현 완료

### 3.1 메시지 표시 영역 ✅ 구현 완료 (ChatMessage)
- **스크롤 가능한 대화창**: ChatHistory 컴포넌트로 구현
- **사용자/봇 메시지 구분**: 
  - 사용자 메시지: 오른쪽 정렬 (justify-end), 파란색 배경 (bg-blue-50)
  - 봇 메시지: 왼쪽 정렬 (justify-start), 흰색 배경 (bg-white)
  - 프로필 아이콘: 사용자 "U", 봇 "AI" (원형 배경)
- **타임스탬프**: 각 메시지 하단에 상대 시간 표시 (formatRelativeTime)
- **메시지 복사 기능**: 봇 메시지에만 복사 버튼 (Copy 아이콘, 복사 성공 시 Check 아이콘)
- **스트리밍 답변** ✅ 구현 완료:
  - 실시간 스트리밍 답변 표시
  - 토큰 단위로 점진적 업데이트
  - 스트리밍 중 로딩 인디케이터 표시
- **재시도 기능** ✅ 구현 완료:
  - 답변 생성 실패 시 재시도 버튼 표시
  - 에러 메시지와 함께 재시도 옵션 제공
  - 이전 사용자 메시지로 자동 재전송

### 3.2 답변 참고자료 시스템 ✅ 구현 완료
- **참고자료 표시**: 
  - CompactReferencesBadge: 간단한 뱃지 형태로 표시
  - "참고 법령/판례 보기 (N개)" 버튼 (ChevronDown/ChevronUp 아이콘)
  - 타입별 분류: 법령, 판례, 결정례, 해석례, 규정
  
- **참고자료 모달** ✅ 구현 완료:
  - ReferencesModalContent: 카드 형태로 분류하여 표시
  - 타입별 필터링 (전체, 법령, 판례, 결정례, 해석례, 규정)
  - 각 참고자료 카드에 상세 정보 표시
  - 외부 링크 아이콘 (ExternalLink) 지원
  
- **문서 사이드바** ✅ 구현 완료:
  - DocumentSidebar: 오른쪽에서 슬라이드되는 사이드바
  - 개별 문서 상세 정보 표시
  - 문서 인덱스 기반 네비게이션
  - ESC 키로 닫기
  - API를 통한 소스 정보 동적 로딩

### 3.3 연관 질문 추천 ✅ 구현 완료 (RelatedQuestions)
- **답변 완료 후 표시**: 각 봇 답변 하단에 연관 질문 섹션 표시
- **동적 생성**: metadata.related_questions 배열에서 가져옴
- **원클릭 질문**: 버튼 클릭으로 즉시 해당 질문 전송
- **UI**: 
  - Lightbulb 아이콘과 "연관 질문" 제목
  - 각 질문은 버튼 형태 (호버 효과)
  - 질문이 없으면 섹션 숨김

## 4. 입력 영역 ✅ 구현 완료

### 4.1 질의 입력창 ✅ 구현 완료 (ChatInput)
- **하단 고정 입력창**: 화면 최하단에 항상 표시 (flex-shrink-0)
- **멀티라인 텍스트**: textarea 사용, 자동 높이 조절 (최대 128px)
- **플레이스홀더**: "메시지를 입력하세요..." 안내 문구
- **Enter 전송, Shift+Enter 줄바꿈**: 키보드 단축키 지원 ✅
- **하단 안내 문구**: "Shift + Enter로 줄바꿈, Enter로 전송"

### 4.2 파일 업로드 ✅ 구현 완료
- **간결한 첨부 버튼**: 입력창 왼쪽에 Paperclip 아이콘 버튼
- **지원 파일 형식**: image/*, .pdf, .doc, .docx, .txt
- **파일 미리보기**: 
  - 입력창 위에 FileAttachment 컴포넌트로 표시
  - 파일명과 용량 표시
  - 삭제 버튼 포함
- **다중 파일 지원**: multiple 속성으로 여러 파일 동시 첨부 ✅

### 4.3 전송 버튼 ✅ 구현 완료
- **명확한 전송 버튼**: 입력창 우측 끝에 Send 아이콘 (파란색 배경)
- **비활성 상태 처리**: 
  - 메시지가 비어있고 파일이 없을 때 비활성화
  - disabled 상태 시 회색 배경
- **로딩 상태**: 
  - isLoading prop으로 전송 중 상태 관리
  - 전송 중에는 버튼과 입력창 모두 비활성화

## 5. 세션 관리 ✅ 구현 완료

### 5.1 대화 세션 ✅ 구현 완료 (useSession hook)
- **세션 ID 자동 생성**: 
  - 새 메시지 전송 시 세션이 없으면 자동 생성
  - 백엔드 API를 통해 고유 세션 ID 생성
- **세션 지속성**: 
  - React 상태로 관리 (useState)
  - 세션 변경 시 메시지 자동 로드
- **세션 초기화**: "새 상담 시작" 버튼으로 새 세션 생성

### 5.2 히스토리 관리 ✅ 구현 완료 (useHistory hook)
- **자동 저장**: 각 메시지 전송 시 백엔드 API를 통해 자동 저장
- **세션별 제목**: 
  - 백엔드에서 자동 생성 (첫 질문 기반)
  - 수동 변경 가능 (이름 변경 기능)
- **메타데이터 저장**: 
  - 생성일 (created_at), 수정일 (updated_at)
  - 메시지 수 (message_count)
- **세션 불러오기**: 클릭으로 과거 대화 이어가기 ✅
- **세션 삭제**: 개별 대화 기록 삭제 옵션 (확인 다이얼로그) ✅

## 6. 부가 기능

### 6.1 사용자 경험 ✅ 구현 완료
- **로딩 인디케이터**: 
  - LoadingSpinner 컴포넌트 존재
  - ChatHistory에서 로딩 상태 표시
  - 전송 중 상태 표시
- **에러 처리** ✅ 구현 완료:
  - ErrorMessage 컴포넌트로 에러 표시
  - 스트림 에러 분류 및 처리
  - 재시도 기능 제공
- **토스트 알림** ✅ 구현 완료:
  - Toast 컴포넌트로 사용자 알림
  - 성공/실패/정보 메시지 표시
  - 자동 사라짐 기능

### 6.2 피드백 시스템 ✅ 구현 완료
- **답변 평가**: 
  - 각 봇 답변에 ThumbsUp/ThumbsDown 버튼 ✅
  - 피드백 전송 기능 구현됨 (sendFeedback API)
  - 선택한 피드백 시각적 표시 (배경색 변경)

## 7. 성능 최적화

### 7.1 데이터 관리 ✅ 구현 완료
- **세션 스토리지**: 
  - React useState로 상태 관리
  - useSession, useChat 훅으로 상태 관리
- **스트리밍 처리** ✅ 구현 완료:
  - 토큰 배치 업데이트로 성능 최적화
  - useStreaming 훅으로 스트리밍 관리
  - 메시지별 버퍼 관리

### 7.2 응답 처리 ✅ 구현 완료
- **스트리밍 답변**: 
  - useStreaming hook 구현됨
  - 실시간 스트리밍 답변 표시 ✅
  - 토큰 단위 점진적 업데이트
- **에러 복구** ✅ 구현 완료:
  - 스트림 에러 분류 및 처리
  - 재시도 기능 제공
  - 에러 메시지 표시

---

## 구현 현황 요약

### ✅ 완전 구현
- 웰컴 스크린 (빠른 질문 카드, 2단계 선택)
- 사이드바 기본 구조 (세션 관리, 히스토리, 검색)
- 대화 인터페이스 (메시지 표시, 참고자료, 연관 질문)
- 입력 영역 (멀티라인 입력, 파일 업로드, 다중 파일)
- 세션 관리 (생성, 불러오기, 삭제, 이름 변경)
- 피드백 시스템 (좋아요/싫어요)
- 스트리밍 답변 (실시간 업데이트)
- 재시도 기능 (에러 복구)
- 문서 사이드바 (상세 정보 표시)
- 참고자료 모달 (타입별 분류 및 필터링)
- 토스트 알림 (사용자 피드백)
- 에러 처리 (에러 메시지 및 복구)

### ⚠️ 미구현 (선택적 기능)
- 다크모드 (설정 패널 UI만 존재)
- 필터 및 정렬 (상수만 정의, UI 미구현)
- 하단 정보 영역 (통계, 링크, 서비스 정보)
- 안내 및 도움말
- 메시지 페이지네이션 (긴 대화 시 lazy loading)
- 캐싱 시스템
- 반응형 디자인 (모바일/태블릿 대응)

---

## 주요 컴포넌트 구조

```
frontend/src/components/
├── chat/
│   ├── ChatHistory.tsx          # 대화 히스토리 표시
│   ├── ChatMessage.tsx           # 개별 메시지 표시
│   ├── ChatInput.tsx             # 입력 영역
│   ├── CompactReferencesBadge.tsx  # 참고자료 뱃지
│   ├── ReferencesModalContent.tsx   # 참고자료 모달
│   ├── DocumentSidebar.tsx      # 문서 상세 사이드바
│   ├── RelatedQuestions.tsx     # 연관 질문
│   ├── ErrorMessage.tsx         # 에러 메시지
│   └── ProgressIndicator.tsx    # 진행 상태 표시
├── sidebar/
│   ├── SidebarContent.tsx       # 사이드바 메인
│   ├── SessionList.tsx          # 세션 리스트
│   ├── SessionItem.tsx          # 세션 아이템
│   └── SearchBar.tsx            # 검색 바
├── welcome/
│   └── WelcomeScreen.tsx       # 웰컴 스크린
└── common/
    ├── Modal.tsx                # 모달 컴포넌트
    ├── Toast.tsx                 # 토스트 알림
    ├── LoadingSpinner.tsx       # 로딩 스피너
    └── FileAttachment.tsx        # 파일 첨부
```

## 주요 훅 구조

```
frontend/src/hooks/
├── useChat.ts           # 채팅 관련 훅
├── useSession.ts        # 세션 관리 훅
├── useHistory.ts        # 히스토리 관리 훅
└── useStreaming.ts      # 스트리밍 처리 훅
```
