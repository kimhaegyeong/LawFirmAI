# 날짜 기반 판례 수집 전략

## 개요

날짜 기반 판례 수집 전략은 선고일자 내림차순으로 체계적인 판례 수집을 수행하는 시스템입니다. 
각 수집 실행마다 별도의 폴더에 raw 데이터를 저장하여 데이터 구분과 관리의 효율성을 높입니다.

**최신 업데이트 (2025-09-26)**:
- ✅ 판례본문 포함 수집 기능 추가
- ✅ JSON 우선, HTML 폴백 방식 구현
- ✅ 중복 데이터 제거 및 최적화
- ✅ 판례일련번호(ID) 기반 안정적 조회
- ✅ **네트워크 안정성 향상**: DNS 해결 실패, 타임아웃 오류 처리 개선
- ✅ **메모리 관리 강화**: 실시간 메모리 모니터링 및 자동 정리
- ✅ **에러 핸들링 개선**: 상세한 오류 메시지 및 해결 방법 제시

## 주요 특징

### 1. 특정 연도 수집 기능 (NEW)
- **직접 연도 지정**: `--year` 파라미터로 원하는 연도 직접 입력
- **정확한 타겟팅**: 2024년, 2023년 등 특정 연도의 판례만 선별 수집
- **유연한 조합**: 특정 연도 + 건수 제한, 출력 디렉토리 지정 등 다양한 옵션

### 1-1. 판례본문 포함 수집 기능 (NEW)
- **기본 동작**: 판례본문(detail_info) 포함하여 수집 (기본값)
- **선택적 제외**: `--no-details` 옵션으로 판례본문 제외 가능
- **JSON 우선 조회**: 일반 판례는 JSON 형태로 구조화된 데이터 수집
- **HTML 폴백**: 국세청 판례 등 JSON 실패 시 HTML로 재시도
- **중복 데이터 제거**: API_응답_원본 제거로 파일 크기 최적화

### 2. 실시간 데이터 보호 (NEW)
- **페이지별 즉시 저장**: API 요청마다 즉시 파일 생성으로 데이터 손실 방지
- **판례일련번호 기준 파일명**: 파일명에 판례일련번호 범위 포함으로 추적 용이
- **오류 복구**: 중간 오류 발생 시에도 현재까지 수집된 데이터 자동 저장
- **실시간 진행상황**: 페이지별 상세 로그와 통계 정보 제공

### 3. 폴더별 Raw 데이터 저장 구조

```
data/raw/precedents/
├── yearly_2024_20250125_143022/          # 연도별 수집 (2024년)
│   ├── page_001_민사-계약손해_123456-123789_150건_20250125_143045.json
│   ├── page_002_민사-계약손해_123790-124200_200건_20250125_143100.json
│   ├── page_003_형사_124201-124500_180건_20250125_143200.json
│   └── page_004_행정_124501-124800_120건_20250125_143300.json
├── quarterly_2024Q4_20250125_144500/     # 분기별 수집 (2024년 4분기)
│   ├── page_001_형사_125000-125500_500건_20250125_144100.json
│   └── page_002_형사_125501-125800_300건_20250125_144200.json
├── monthly_2024년12월_20250125_145000/   # 월별 수집 (2024년 12월)
│   ├── page_001_행정_126000-126200_200건_20250125_145100.json
│   └── page_002_행정_126201-126350_150건_20250125_145200.json
├── weekly_20250120주_20250125_145500/    # 주별 수집 (2025년 1월 20일 주)
│   ├── page_001_기타_127000-127100_100건_20250125_145600.json
│   └── page_002_기타_127101-127180_80건_20250125_145700.json
├── yearly_collection_summary_20250125_143022.json
├── quarterly_collection_summary_20250125_144500.json
├── monthly_collection_summary_20250125_145000.json
└── weekly_collection_summary_20250125_145500.json
```

### 4. 수집 전략별 특징

#### 특정 연도 수집 (NEW)
- **기간**: 지정된 단일 연도 (예: 2024년)
- **목표**: 해당 연도의 모든 판례 (무제한)
- **폴더명**: `yearly_{지정연도}_{타임스탬프}`
- **사용법**: `--year 2024 --unlimited`

#### 연도별 수집 (Yearly)
- **기간**: 최근 5년 (2021-2025)
- **목표**: 연간 2,000건
- **총 목표**: 10,000건
- **폴더명**: `yearly_{년도}_{타임스탬프}`

#### 분기별 수집 (Quarterly)
- **기간**: 최근 2년 (8분기)
- **목표**: 분기당 500건
- **총 목표**: 4,000건
- **폴더명**: `quarterly_{분기}_{타임스탬프}`

#### 월별 수집 (Monthly)
- **기간**: 최근 1년 (12개월)
- **목표**: 월간 200건
- **총 목표**: 2,400건
- **폴더명**: `monthly_{년월}_{타임스탬프}`

#### 주별 수집 (Weekly)
- **기간**: 최근 3개월 (12주)
- **목표**: 주간 100건
- **총 목표**: 1,200건
- **폴더명**: `weekly_{주시작일}주_{타임스탬프}`

## 사용법

### 1. 기본 사용법

#### **특정 연도 수집 (NEW)**
```bash
# 2024년 판례만 수집 (판례본문 포함, 기본값)
python scripts/precedent/collect_by_date.py --strategy yearly --year 2024 --unlimited

# 2023년 판례만 수집 (판례본문 제외)
python scripts/precedent/collect_by_date.py --strategy yearly --year 2023 --unlimited --no-details

# 2022년 판례만 수집 (소량 테스트)
python scripts/precedent/collect_by_date.py --strategy yearly --year 2022 --count 100
```

#### **기간별 수집**
```bash
# 연도별 수집 (최근 5년, 연간 2000건)
python scripts/precedent/collect_by_date.py --strategy yearly --target 10000

# 분기별 수집 (최근 2년, 분기당 500건)
python scripts/precedent/collect_by_date.py --strategy quarterly --target 4000

# 월별 수집 (최근 1년, 월간 200건)
python scripts/precedent/collect_by_date.py --strategy monthly --target 2400

# 주별 수집 (최근 3개월, 주간 100건)
python scripts/precedent/collect_by_date.py --strategy weekly --target 1200

# 모든 전략 순차 실행 (총 17,600건)
python scripts/precedent/collect_by_date.py --strategy all --target 20000
```

### 2. 고급 옵션

#### **특정 연도 고급 옵션**
```bash
# 특정 연도 + 건수 제한
python scripts/precedent/collect_by_date.py --strategy yearly --year 2024 --target 5000

# 특정 연도 + 출력 디렉토리 지정
python scripts/precedent/collect_by_date.py --strategy yearly --year 2024 --unlimited --output data/custom/precedents

# 특정 연도 + 드라이런 모드
python scripts/precedent/collect_by_date.py --strategy yearly --year 2024 --unlimited --dry-run
```

#### **기간별 고급 옵션**
```bash
# 특정 기간 수 수집
python scripts/precedent/collect_by_date.py --strategy yearly --target 5000 --count 3

# 출력 디렉토리 지정
python scripts/precedent/collect_by_date.py --strategy monthly --target 1000 --output data/custom/precedents

# 드라이런 모드 (실제 수집 없이 계획만 출력)
python scripts/precedent/collect_by_date.py --strategy all --target 10000 --dry-run

# 재시작 모드 (중단된 지점부터 재시작)
python scripts/precedent/collect_by_date.py --strategy yearly --target 5000 --resume
```

### 3. 파라미터 설명

| 파라미터 | 타입 | 기본값 | 설명 | 예시 |
|----------|------|--------|------|------|
| `--strategy` | str | all | 수집 전략 선택 | yearly, quarterly, monthly, weekly, all |
| `--year` | int | None | 특정 연도 지정 (NEW) | 2024, 2023, 2022 |
| `--target` | int | None | 목표 수집 건수 | 10000, 20000 |
| `--count` | int | None | 수집할 기간 수 | 5 (5년), 10 (10년) |
| `--output` | str | data/raw/precedents | 출력 디렉토리 | data/custom/precedents |
| `--unlimited` | flag | True | 건수 제한 없이 최대한 수집 | --unlimited |
| `--no-details` | flag | False | 판례본문 제외하고 수집 (NEW) | --no-details |
| `--dry-run` | flag | False | 실제 수집 없이 계획만 출력 | --dry-run |
| `--resume` | flag | False | 중단된 지점부터 재시작 | --resume |

### 4. 프로그래밍 방식 사용

```python
from source.data.law_open_api_client import LawOpenAPIConfig
from scripts.precedent.date_based_collector import DateBasedPrecedentCollector

# API 설정
config = LawOpenAPIConfig()

# 특정 연도 수집 (판례본문 포함, 기본값)
collector = DateBasedPrecedentCollector(config, include_details=True)
years = [2024]  # 2024년만
result = collector.collect_by_yearly_strategy(years, 2000)

# 특정 연도 수집 (판례본문 제외)
collector = DateBasedPrecedentCollector(config, include_details=False)
years = [2023]  # 2023년만
result = collector.collect_by_yearly_strategy(years, 2000)

# 연도별 수집
years = [2025, 2024, 2023, 2022, 2021]
result = collector.collect_by_yearly_strategy(years, 2000)

# 분기별 수집
quarters = collector.generate_date_ranges(DateCollectionStrategy.QUARTERLY, 8)
result = collector.collect_by_quarterly_strategy(quarters, 500)
```

## 데이터 구조

### 1. 폴더 구조

각 수집 실행마다 다음과 같은 폴더 구조가 생성됩니다:

```
{전략}_{기간}_{타임스탬프}/
├── batch_{카테고리}_{건수}건_{타임스탬프}.json
├── batch_{카테고리}_{건수}건_{타임스탬프}.json
└── ...
```

### 2. 페이지별 파일 구조 (NEW)

```json
{
  "metadata": {
    "page": 1,
    "category": "기타",
    "count": 20,
    "date_range": "20240101~20241231",
    "saved_at": "2025-09-26T09:19:45.178708",
    "batch_id": "page_1_20250926_091545",
    "serial_number_range": "343357-606663",
    "include_details": true
  },
  "precedents": [
    {
      "id": "1",
      "사건번호": "2023노7060",
      "데이터출처명": "대법원",
      "사건종류코드": "400102",
      "사건종류명": "형사",
      "선고": "선고",
      "선고일자": "2024.12.27",
      "판례일련번호": "606037",
      "판결유형": "판결",
      "법원종류코드": "",
      "법원명": "수원지방법원",
      "판례상세링크": "/DRF/lawService.do?OC={OC}&target=prec&ID=606037&type=HTML&mobileYn=",
      "사건명": "사기",
      "detail_info": {
        "판례일련번호": "606037",
        "사건명": "사기",
        "사건번호": "2023노7060, 2024노6372(병합)",
        "법원명": "수원지방법원",
        "선고일자": "20241227",
        "판결유형": "판결",
        "사건유형": "형사",
        "판결요지": "",
        "판시사항": "",
        "참조조문": "",
        "참조판례": "",
        "판례내용": "【피 고 인】 피고인<br/>【항 소 인】 피고인(원심판결들에 대하여) 및 검사(제1 원심판결에 대하여)<br/>...전체 판결문...",
        "사건종류코드": "400102",
        "법원종류코드": "400202",
        "선고": "선고",
        "수집일시": "2025-09-26T09:19:25.806390"
      }
    }
  ]
}
```

### 3. 파일명 규칙 (NEW)

#### 페이지별 파일명 (NEW)
```
page_{페이지번호}_{시작판례일련번호}-{끝판례일련번호}_{건수}건_{타임스탬프}.json
```

**예시:**
- `page_001_343357-606663_20건_20250926_091545.json`
- `page_002_242367-607393_20건_20250926_091607.json`
- `page_003_242333-607673_20건_20250926_091630.json`

**변경사항:**
- 카테고리 제거로 파일명 단순화
- 판례일련번호 범위로 추적 용이

#### 배치 파일명 (기존)
```
batch_{카테고리}_{시작판례일련번호}-{끝판례일련번호}_{건수}건_{타임스탬프}.json
```

**예시:**
- `batch_민사-계약손해_123456-123789_150건_20250125_143045.json`
- `batch_형사_123790-124200_200건_20250125_143100.json`

### 3. 수집 요약 파일 구조

```json
{
  "strategy": "yearly",
  "years": [2025, 2024, 2023, 2022, 2021],
  "target_per_year": 2000,
  "collected_by_year": {
    "2025": 1850,
    "2024": 1950,
    "2023": 1800,
    "2022": 1750,
    "2021": 1650
  },
  "total_collected": 9000,
  "start_time": "2025-01-25T14:30:22.123456",
  "end_time": "2025-01-25T15:45:30.654321"
}
```

## 판례본문 수집 기능 (NEW)

### 1. 수집 방식

#### JSON 우선 조회
- **일반 판례**: JSON 형태로 구조화된 데이터 수집
- **응답 구조**: `PrecService` 객체에서 판례 정보 추출
- **필드 매핑**: 판례정보일련번호, 사건명, 판례내용 등 17개 필드

#### HTML 폴백 조회
- **국세청 판례**: JSON 실패 시 HTML로 재시도
- **응답 구조**: `Law` 객체 또는 문자열 형태
- **제한사항**: 국세청 판례는 HTML만 지원 (API 문서 명시)

### 2. 데이터 최적화

#### 중복 데이터 제거
- **API_응답_원본 제거**: 파일 크기 대폭 감소
- **필수 정보만 저장**: 필요한 판례 정보만 포함
- **메타데이터 최소화**: 수집일시만 추가

#### 안정적 조회
- **판례일련번호(ID)만 사용**: 다른 파라미터 제거
- **고유성 보장**: 각 판례를 정확히 식별
- **API 안정성**: 일관된 응답 구조

### 3. 수집된 정보

```json
{
  "detail_info": {
    "판례일련번호": "606037",
    "사건명": "사기",
    "사건번호": "2023노7060, 2024노6372(병합)",
    "법원명": "수원지방법원",
    "선고일자": "20241227",
    "판결유형": "판결",
    "사건유형": "형사",
    "판결요지": "",
    "판시사항": "",
    "참조조문": "",
    "참조판례": "",
    "판례내용": "전체 판결문...",
    "사건종류코드": "400102",
    "법원종류코드": "400202",
    "선고": "선고",
    "수집일시": "2025-09-26T09:19:25.806390"
  }
}
```

## 성능 최적화

### 1. API 요청 최적화

- **선고일자 내림차순 정렬**: `sort: "ddes"` 파라미터 사용
- **배치 크기 최적화**: 한 번에 20건씩 조회 (판례본문 수집 시)
- **랜덤 지연**: API 요청 간 1-3초 랜덤 지연
- **재시도 메커니즘**: 최대 3회 재시도 (지수 백오프)
- **판례본문 수집 지연**: 첫 요청 0.5초, 재시도 시 지수 백오프

### 2. 메모리 최적화

- **배치 저장**: 20건마다 파일로 저장 (판례본문 수집 시)
- **중복 방지**: Set 자료구조로 중복 ID 관리 (최대 50,000건)
- **지연 로딩**: 필요할 때만 데이터 로드
- **메모리 제한**: 중복 체크용 메모리 사용량 제한

### 3. 에러 처리

- **API 제한 확인**: 남은 요청 수 모니터링
- **Graceful Shutdown**: Ctrl+C로 안전한 중단
- **체크포인트**: 중단 시 진행 상황 저장

## 모니터링 및 로깅

### 1. 로그 레벨

- **INFO**: 주요 진행 상황
- **DEBUG**: 상세한 처리 과정
- **WARNING**: 주의사항
- **ERROR**: 오류 상황

### 2. 진행 상황 추적

```
📅 날짜 기반 판례 수집 시작
================================
🎯 수집 전략: yearly
📊 목표 건수: 10,000건
📁 출력 디렉토리: data/raw/precedents
================================

📊 2025년 판례 수집 중... (목표: 2000건)
페이지 1: 100건 신규, 0건 중복 (누적: 100/2000건)
페이지 2: 95건 신규, 5건 중복 (누적: 195/2000건)
...
✅ 2025년 완료: 1850건 수집 (누적: 1850건)

📊 2024년 판례 수집 중... (목표: 2000건)
...
✅ 2024년 완료: 1950건 수집 (누적: 3800건)

🎉 연도별 수집 완료: 총 9000건
```

## 예상 수집량

| 전략 | 기간 | 목표/기간 | 총 목표 | 예상 실제 | 폴더 수 | 판례본문 포함 |
|------|------|-----------|---------|-----------|---------|---------------|
| **특정 연도** | 1년 | 무제한 | 해당 연도 전체 | 5,000-15,000건 | 1개 | ✅ 기본값 |
| 연도별 | 5년 | 2,000건/년 | 10,000건 | 8,000-12,000건 | 5개 | ✅ 기본값 |
| 분기별 | 2년 | 500건/분기 | 4,000건 | 3,000-5,000건 | 8개 | ✅ 기본값 |
| 월별 | 1년 | 200건/월 | 2,400건 | 2,000-3,000건 | 12개 | ✅ 기본값 |
| 주별 | 3개월 | 100건/주 | 1,200건 | 800-1,500건 | 12개 | ✅ 기본값 |
| **총합** | - | - | **17,600건** | **13,800-21,500건** | **37개** | **판례본문 포함** |

**참고사항:**
- 판례본문 포함 시 수집 속도가 느려짐 (각 판례마다 추가 API 호출)
- `--no-details` 옵션으로 판례본문 제외 가능
- 파일 크기: 판례본문 포함 시 약 3-5배 증가

## 장점

### 1. 데이터 구분
- **폴더별 저장**: 각 수집 실행마다 별도 폴더
- **타임스탬프**: 수집 시점 추적 가능
- **전략별 구분**: 연도별, 분기별, 월별, 주별 구분

### 2. 효율성
- **선고일자 내림차순**: 최신 판례 우선 수집
- **중복 방지**: 기존 수집 데이터와 중복 제거
- **배치 처리**: 메모리 효율적인 처리

### 3. 확장성
- **새로운 전략 추가**: 쉽게 새로운 날짜 전략 추가
- **설정 변경**: 목표 건수, 기간 등 유연한 설정
- **모듈화**: 독립적인 모듈로 구성

### 4. 모니터링
- **진행 상황 추적**: 실시간 진행 상황 확인
- **수집 요약**: 각 전략별 수집 결과 요약
- **에러 처리**: 상세한 에러 로깅

## 주의사항

### 1. API 제한
- **일일 1000회 제한**: API 요청 수 모니터링 필요
- **요청 간 지연**: 1-3초 랜덤 지연 필수
- **재시도 제한**: 최대 3회 재시도

### 2. 저장 공간
- **폴더 수 증가**: 수집 실행마다 새 폴더 생성
- **디스크 공간**: 대용량 데이터 저장 고려
- **정리 작업**: 오래된 폴더 정리 필요

### 3. 데이터 품질
- **중복 제거**: 기존 데이터와 중복 확인
- **데이터 검증**: 수집된 데이터 품질 확인
- **카테고리 분류**: 자동 분류 정확도 검토

## 향후 개선 사항

### 1. 기능 개선
- **병렬 처리**: 여러 전략 동시 실행
- **증분 수집**: 새로운 데이터만 수집
- **자동 정리**: 오래된 폴더 자동 정리

### 2. 성능 개선
- **캐싱**: API 응답 캐싱
- **압축**: 저장 파일 압축
- **인덱싱**: 빠른 검색을 위한 인덱스

### 3. 모니터링 개선
- **대시보드**: 웹 기반 모니터링
- **알림**: 수집 완료 알림
- **통계**: 상세한 수집 통계
