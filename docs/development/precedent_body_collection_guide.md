# 판례본문 수집 가이드

## 개요

판례본문 수집 기능은 LAW OPEN API를 통해 판례의 상세 정보(판례본문)를 포함하여 수집하는 기능입니다. 
기본적으로 판례본문이 포함된 수집이 기본값이며, 필요에 따라 제외할 수 있습니다.

## 주요 특징

### 1. JSON 우선, HTML 폴백 방식
- **일반 판례**: JSON 형태로 구조화된 데이터 수집
- **국세청 판례**: HTML 형태로 수집 (API 제한사항)
- **자동 폴백**: JSON 실패 시 자동으로 HTML로 재시도

### 2. 판례일련번호(ID) 기반 안정적 조회
- **고유성 보장**: 각 판례를 정확히 식별
- **API 안정성**: 일관된 응답 구조
- **단순화된 파라미터**: 다른 파라미터 제거로 안정성 향상

### 3. 데이터 최적화
- **중복 데이터 제거**: API_응답_원본 제거로 파일 크기 최적화
- **필수 정보만 저장**: 필요한 판례 정보만 포함
- **메타데이터 최소화**: 수집일시만 추가

## 사용법

### 1. 기본 사용법

#### 판례본문 포함 수집 (기본값)
```bash
# 2024년 판례 수집 (판례본문 포함)
python scripts/precedent/collect_by_date.py --strategy yearly --year 2024 --unlimited

# 소량 테스트
python scripts/precedent/collect_by_date.py --strategy yearly --year 2024 --count 10
```

#### 판례본문 제외 수집
```bash
# 2024년 판례 수집 (판례본문 제외)
python scripts/precedent/collect_by_date.py --strategy yearly --year 2024 --unlimited --no-details

# 빠른 수집 (기본 정보만)
python scripts/precedent/collect_by_date.py --strategy yearly --year 2024 --count 100 --no-details
```

### 2. 프로그래밍 방식 사용

```python
from source.data.law_open_api_client import LawOpenAPIConfig
from scripts.precedent.date_based_collector import DateBasedPrecedentCollector

# API 설정
config = LawOpenAPIConfig()

# 판례본문 포함 수집 (기본값)
collector = DateBasedPrecedentCollector(config, include_details=True)
years = [2024]
result = collector.collect_by_yearly_strategy(years, 2000)

# 판례본문 제외 수집
collector = DateBasedPrecedentCollector(config, include_details=False)
years = [2023]
result = collector.collect_by_yearly_strategy(years, 2000)
```

## 수집된 데이터 구조

### 1. 기본 판례 정보
```json
{
  "id": "1",
  "사건번호": "2023노7060",
  "데이터출처명": "대법원",
  "사건종류코드": "400102",
  "사건종류명": "형사",
  "선고": "선고",
  "선고일자": "2024.12.27",
  "판례일련번호": "606037",
  "판결유형": "판결",
  "법원종류코드": "",
  "법원명": "수원지방법원",
  "판례상세링크": "/DRF/lawService.do?OC={OC}&target=prec&ID=606037&type=HTML&mobileYn=",
  "사건명": "사기"
}
```

### 2. 판례본문 상세 정보 (detail_info)
```json
{
  "detail_info": {
    "판례일련번호": "606037",
    "사건명": "사기",
    "사건번호": "2023노7060, 2024노6372(병합)",
    "법원명": "수원지방법원",
    "선고일자": "20241227",
    "판결유형": "판결",
    "사건유형": "형사",
    "판결요지": "",
    "판시사항": "",
    "참조조문": "",
    "참조판례": "",
    "판례내용": "【피 고 인】 피고인<br/>【항 소 인】 피고인(원심판결들에 대하여) 및 검사(제1 원심판결에 대하여)<br/>...전체 판결문...",
    "사건종류코드": "400102",
    "법원종류코드": "400202",
    "선고": "선고",
    "수집일시": "2025-09-26T09:19:25.806390"
  }
}
```

## API 호출 방식

### 1. JSON 우선 조회
```python
# 일반 판례 조회
params = {
    'target': 'prec',
    'type': 'JSON',
    'ID': '606037'  # 판례일련번호
}
```

**응답 구조:**
```json
{
  "PrecService": {
    "판례정보일련번호": "606037",
    "사건명": "사기",
    "사건번호": "2023노7060, 2024노6372(병합)",
    "법원명": "수원지방법원",
    "선고일자": "20241227",
    "판결유형": "판결",
    "사건종류명": "형사",
    "판결요지": "",
    "판시사항": "",
    "참조조문": "",
    "참조판례": "",
    "판례내용": "전체 판결문...",
    "사건종류코드": "400102",
    "법원종류코드": "400202",
    "선고": "선고"
  }
}
```

### 2. HTML 폴백 조회
```python
# 국세청 판례 조회 (JSON 실패 시)
params = {
    'target': 'prec',
    'type': 'HTML',
    'ID': '605441'  # 판례일련번호
}
```

**응답 구조:**
```json
{
  "Law": "HTML 형태의 판례 내용..."  // 또는 딕셔너리 형태
}
```

## 성능 고려사항

### 1. 수집 속도
- **판례본문 포함**: 각 판례마다 추가 API 호출 필요
- **수집 시간**: 판례본문 포함 시 약 3-5배 느려짐
- **API 지연**: 첫 요청 0.5초, 재시도 시 지수 백오프

### 2. 파일 크기
- **판례본문 포함**: 약 3-5배 큰 파일 크기
- **중복 제거**: API_응답_원본 제거로 최적화
- **압축 효과**: JSON 구조로 효율적 저장

### 3. 메모리 사용량
- **배치 크기**: 20건씩 처리 (판례본문 수집 시)
- **중복 체크**: 최대 50,000건 메모리 제한
- **지연 로딩**: 필요할 때만 데이터 로드

## 에러 처리

### 1. API 오류 처리
- **재시도 메커니즘**: 최대 3회 재시도
- **지수 백오프**: 재시도 간격 점진적 증가
- **폴백 처리**: JSON 실패 시 HTML로 자동 전환

### 2. 데이터 검증
- **응답 구조 확인**: PrecService, Law 구조 검증
- **필수 필드 확인**: 판례일련번호, 사건명 등 필수 정보
- **오류 로깅**: 상세한 오류 정보 기록

### 3. 중단 처리
- **Graceful Shutdown**: Ctrl+C로 안전한 중단
- **진행 상황 저장**: 중단 시까지 수집된 데이터 보존
- **재시작 지원**: 중단된 지점부터 재시작 가능

## 모니터링 및 로깅

### 1. 진행 상황 추적
```
📄 판례본문 수집 중: 사기 (ID: 606037)
🔍 판례본문 수집 시작: 사기 (ID: 606037)
✅ 판례본문 수집 완료: 사기 (ID: 606037)
```

### 2. 오류 상황 추적
```
⚠️ 판례일련번호가 없어 판례본문 수집 불가: Unknown
❌ 판례본문 수집 실패: 606037 (재시도 3회 초과)
```

### 3. 성능 모니터링
```
📊 페이지 1: 20건 신규, 0건 중복 (누적: 20/2000건)
⏱️ 판례본문 수집 시간: 45.2초
💾 파일 크기: 1.2MB (판례본문 포함)
```

## 주의사항

### 1. API 제한
- **일일 1000회 제한**: 판례본문 수집 시 더 빨리 도달
- **요청 간 지연**: 0.5초 기본 지연 필수
- **재시도 제한**: 최대 3회 재시도

### 2. 데이터 품질
- **국세청 판례**: HTML 형태로만 제공 (API 제한)
- **빈 필드**: 일부 판례에서 판결요지, 판시사항 등이 비어있을 수 있음
- **인코딩**: HTML 태그가 포함된 판례내용

### 3. 저장 공간
- **파일 크기**: 판례본문 포함 시 대용량 파일
- **디스크 공간**: 충분한 저장 공간 확보 필요
- **백업**: 중요한 데이터는 별도 백업 권장

## 향후 개선 사항

### 1. 성능 개선
- **병렬 처리**: 여러 판례본문 동시 수집
- **캐싱**: 중복 판례본문 캐싱
- **압축**: 저장 파일 압축

### 2. 기능 개선
- **선택적 수집**: 특정 필드만 선택적 수집
- **증분 수집**: 새로운 판례본문만 수집
- **자동 재시도**: 실패한 판례본문 자동 재수집

### 3. 모니터링 개선
- **대시보드**: 웹 기반 수집 현황 모니터링
- **알림**: 수집 완료 및 오류 알림
- **통계**: 상세한 수집 통계 및 분석
