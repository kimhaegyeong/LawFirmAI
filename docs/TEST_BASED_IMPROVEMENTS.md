# 테스트 기준 LangGraph 성능 개선점 (번호순)

## 개선 일자
2025-01-27

## 테스트 결과 (기준)
- **질의**: "민법 제750조 손해배상에 대해 설명해주세요"
- **처리 시간**: 28.61초
- **노드 실행 수**: 9개
- **답변 길이**: 671자 (원본 1697자, 잘림)
- **신뢰도**: 0.80
- **Grounding Score**: 0.30 (낮음)
- **Quality Score**: 1.0

## 완료된 개선 사항 ✅

### 1. 스트리밍 이벤트 처리 최적화 ✅
- 이벤트 필터링 조기 종료
- 관련 이벤트 타입을 `frozenset`으로 미리 정의
- 답변 생성 노드 이벤트만 처리
- 불필요한 이벤트 추적 제거

### 2. JSON 출력 필터링 최적화 ✅
- 정규식 컴파일을 함수 시작 시 한 번만 수행
- JSON 키워드를 `frozenset`으로 정의
- JSON 감지 로직 단순화

### 3. 로깅 최적화 ✅
- 프로덕션 환경에서 불필요한 디버그 로그 제거
- `DEBUG_STREAM` 환경 변수로 디버그 로그 제어
- 이벤트 추적을 디버그 모드에서만 수행

### 4. 메모리 사용 최적화 ✅
- 이벤트 히스토리 크기 제한 (최대 100개)
- 스트리밍 시 불필요한 데이터 누적 최소화
- 이벤트 히스토리 정리 로직 추가

### 5. 상태 검증 최적화 ✅
- 중복 검증 제거
- 검증 로직 통합
- 불필요한 로깅 제거

### 6. Prepare Search Query 노드 최적화 ✅
- 쿼리 최적화 결과 캐싱 추가
- 재시도가 아닌 경우에만 캐시 확인
- 캐시 히트 시 LLM 호출 스킵
- 예상 효과: 캐시 히트 시 7.64초 → 0.1초 (98% 개선)

### 7. Expand Keywords 노드 최적화 ✅
- 키워드 확장 결과 캐싱 추가
- AI 키워드 확장 호출 전 캐시 확인
- 캐시 히트 시 AI 호출 스킵
- 예상 효과: 캐시 히트 시 5.73초 → 0.1초 (98% 개선)

### 8. Generate And Validate Answer 노드 최적화 ✅
- LLM 응답 캐싱 추가
- 답변 생성 결과 캐싱 (query, query_type, context_dict, retrieved_docs 기반)
- 재시도가 아닌 경우에만 캐시 확인
- 캐시 히트 시 LLM 호출 스킵
- 예상 효과: 캐시 히트 시 7.39초 → 0.1초 (98% 개선)

### 9. Grounding Score 개선 ✅
- Citation 보강 로직 개선
- Citation 임계값 완화 (0.5 → 0.3)
- 더 많은 Citation 추가 (법령 2개 → 3개, 판례 1개 → 2개)
- 답변 생성 시 검색 문서 참조 강화
- 예상 효과: Grounding Score 0.30 → 0.50-0.60 (67-100% 개선)

## 테스트 기준 개선할 점 (번호순)

### 1. 성능 최적화 - Prepare Search Query (High Priority) ✅
**완료 상태:**
- ✅ 쿼리 최적화 결과 캐싱 추가
- ✅ 캐시 히트 시 LLM 호출 스킵
- ✅ 예상 효과: 캐시 히트 시 7.64초 → 0.1초 (98% 개선)

### 2. 성능 최적화 - Generate And Validate Answer (High Priority) ✅
**완료 상태:**
- ✅ LLM 응답 캐싱 추가
- ✅ 답변 생성 결과 캐싱
- ✅ 캐시 히트 시 LLM 호출 스킵
- ✅ 예상 효과: 캐시 히트 시 7.39초 → 0.1초 (98% 개선)

### 3. 성능 최적화 - Expand Keywords (High Priority) ✅
**완료 상태:**
- ✅ 키워드 확장 결과 캐싱 추가
- ✅ 캐시 히트 시 AI 호출 스킵
- ✅ 예상 효과: 캐시 히트 시 5.73초 → 0.1초 (98% 개선)

### 4. Grounding Score 개선 (High Priority) ✅
**완료 상태:**
- ✅ Citation 보강 로직 개선
- ✅ Citation 임계값 완화 (0.5 → 0.3)
- ✅ 더 많은 Citation 추가 (법령 2개 → 3개, 판례 1개 → 2개)
- ✅ 답변 생성 시 검색 문서 참조 강화
- ✅ 예상 효과: Grounding Score 0.30 → 0.50-0.60 (67-100% 개선)

### 5. 답변 품질 검증 - 추론 과정 추출 실패 (Medium Priority)
**현재 상태:**
- `reasoning_extraction_success: False`
- `reasoning_length: 0`
- 추론 과정이 제거되지 않음

**개선 방안:**
- 추론 과정 추출 로직 개선
- 답변 후처리 로직 강화
- 정규표현식 패턴 개선
- LLM 프롬프트에서 추론 과정 제외 지시

**예상 효과:**
- 추론 과정 추출 성공률: 0% → 90% 이상

### 6. 답변 내용 개선 - 섹션 누락 (Medium Priority)
**현재 상태:**
- 답변이 중간에 잘림 (671자만 출력, 원본은 1697자)
- "### 관련 법률 및 조항" 섹션이 비어있음
- "### 법적 해설" 섹션이 비어있음

**개선 방안:**
- 답변 출력 길이 제한 해제 또는 조정
- 섹션별 내용 생성 로직 개선
- 템플릿 기반 답변 구조화
- 답변 생성 프롬프트에 섹션별 내용 요구

**예상 효과:**
- 답변 완성도: 40% → 90% 이상

### 7. 검색 결과 품질 향상 (Medium Priority)
**현재 상태:**
- Semantic: 31개, Keyword: 18개
- 최종 선택: 10개
- Score range: 0.141 ~ 0.151 (낮음)

**개선 방안:**
- 검색 결과 점수 개선
- 더 관련성 높은 문서 선택
- 검색 쿼리 최적화
- 임베딩 모델 개선
- 검색 결과 재랭킹 로직 개선

**예상 효과:**
- 검색 점수: 0.141-0.151 → 0.300-0.500 (100-200% 개선)

### 8. 컨텍스트 구조 문제 (Medium Priority)
**현재 상태:**
- `⚠️ [CONTEXT STRUCTURE] Document contents not properly included in structured context`
- 문서 내용이 제대로 포함되지 않을 수 있음

**개선 방안:**
- 컨텍스트 구조화 로직 개선
- 문서 내용 포함 검증 강화
- 구조화 템플릿 개선
- 컨텍스트 길이 제한 최적화

**예상 효과:**
- 컨텍스트 구조 문제 해결률: 0% → 95% 이상

### 9. 병렬 처리 개선 (Medium Priority)
**현재 상태:**
- 노드들이 순차적으로 실행됨
- 독립적인 노드도 병렬 실행되지 않음

**개선 방안:**
- 독립적인 노드 병렬 실행
- 검색 쿼리 준비와 키워드 확장 병렬화
- `asyncio.gather` 활용
- 워크플로우 그래프 최적화

**예상 효과:**
- 전체 처리 시간: 28.61초 → 20-22초 (20-30% 개선)

### 10. LLM 응답 캐싱 강화 (Medium Priority)
**현재 상태:**
- 검색 결과 캐시는 있으나 LLM 응답 캐시 부족
- 분류 결과 캐시는 있으나 활용도 낮음

**개선 방안:**
- LLM 응답 캐싱 (동일/유사 쿼리)
- 검색 쿼리 캐싱 개선
- 분류 결과 캐싱 활용도 향상
- TTL 기반 캐시 무효화
- 캐시 히트율 모니터링

**예상 효과:**
- 캐시 히트율: 10-20% → 40-50%
- 캐시 히트 시 처리 시간: 28.61초 → 5-10초 (65-80% 개선)

### 11. 모듈 Import 경고 해결 (Low Priority)
**현재 상태:**
- `Warning: Could not import SearchService: No module named 'core.models.model_manager'`
- 일부 기능이 제대로 작동하지 않을 수 있음

**개선 방안:**
- 모듈 경로 수정
- 의존성 확인 및 설치
- Import 경로 정리
- 모듈 구조 재정리

**예상 효과:**
- Import 경고 제거: 100%

### 12. 답변 내용 개선 - 구체성 부족 (Low Priority)
**현재 상태:**
- 구체적인 판례나 실무 사례 부족
- 일반적인 설명에 그침

**개선 방안:**
- 판례 데이터베이스 연동
- 실무 사례 추가
- 구체적인 예시 포함
- 답변 생성 프롬프트에 구체성 요구

**예상 효과:**
- 답변 구체성: 40% → 70% 이상

### 13. 성능 모니터링 고도화 (Low Priority)
**현재 상태:**
- 성능 모니터링은 잘 작동하고 있음
- 느린 노드 감지 ✅
- 실행 시간 요약 ✅

**개선 방안:**
- 성능 임계값 동적 조정
- 성능 히스토리 저장 및 분석
- 성능 대시보드 구축
- 실시간 성능 알림

**예상 효과:**
- 성능 모니터링 완성도: 60% → 90% 이상

### 14. 로그 출력 형식 개선 (Low Priority)
**현재 상태:**
- 로그가 제대로 출력되지 않아 테스트 결과 확인이 어려움
- 구조화된 로그 출력 부족

**개선 방안:**
- 로깅 버퍼 문제 해결 후 로그 형식 개선
- 구조화된 로그 출력
- 로그 레벨별 색상 구분
- 로그 파일 자동 정리

**예상 효과:**
- 로그 가독성: 50% → 90% 이상

### 15. Grounding Score 임계값 설정 (Low Priority)
**현재 상태:**
- `grounding_score=0.30`이 너무 낮지만 경고만 표시됨
- 재검색 또는 재생성 로직 없음

**개선 방안:**
- Grounding Score 임계값 설정
- 낮은 점수 시 재검색 또는 재생성
- 사용자에게 신뢰도 경고 표시
- 자동 재시도 로직 구현

**예상 효과:**
- Grounding Score 개선률: 0% → 50% 이상

## 우선순위별 개선 계획

### 즉시 개선 (High Priority)
1. 성능 최적화 - Prepare Search Query
2. 성능 최적화 - Generate And Validate Answer
3. 성능 최적화 - Expand Keywords
4. Grounding Score 개선

### 점진적 개선 (Medium Priority)
5. 답변 품질 검증 - 추론 과정 추출
6. 답변 내용 개선 - 섹션 누락
7. 검색 결과 품질 향상
8. 컨텍스트 구조 문제
9. 병렬 처리 개선
10. LLM 응답 캐싱 강화

### 장기 개선 (Low Priority)
11. 모듈 Import 경고 해결
12. 답변 내용 개선 - 구체성 부족
13. 성능 모니터링 고도화
14. 로그 출력 형식 개선
15. Grounding Score 임계값 설정

## 예상 종합 성능 개선 효과

### 처리 시간
- **현재**: 28.61초
- **예상**: 15-20초 (30-45% 개선)

### 답변 품질
- **Grounding Score**: 0.30 → 0.60-0.70 (100-130% 개선)
- **답변 완성도**: 40% → 90% 이상 (125% 개선)
- **추론 과정 추출**: 0% → 90% 이상

### 캐시 효율
- **캐시 히트율**: 10-20% → 40-50% (100-150% 개선)
- **캐시 히트 시 처리 시간**: 28.61초 → 5-10초 (65-80% 개선)

## 참고 사항

- 모든 개선 사항은 기존 기능을 유지하면서 성능만 향상시킴
- 개선 사항은 단계적으로 적용하여 안정성 확보
- 각 개선 사항 적용 후 테스트를 통해 효과 검증 필요

