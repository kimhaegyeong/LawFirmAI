# -*- coding: utf-8 -*-
"""
SQL?키?드?벡???????백 루프 ?스??

?나리오:
- SQL ?우?이 ?합??질의?나 DB???치 ?코?? ?어 0?반환
- ?크?로?? `metadata.force_rag_fallback=True`??정?고 컨텍?트 보강 ?시?? ?행
- 최종 결과???류 ?이 ?답???성?며, 메??이?에 ?우???보가 ?함?는지 검?
"""

import asyncio
import sys
from pathlib import Path

import pytest

# ?로?트 루트 경로 추?
project_root = Path(__file__).parent.parent
sys.path.insert(0, str(project_root))


@pytest.mark.asyncio
async def test_sql_zero_rows_triggers_rag_fallback():
    from source.agents.workflow_service import LangGraphWorkflowService
    from infrastructure.utils.langgraph_config import LangGraphConfig

    config = LangGraphConfig.from_env()
    service = LangGraphWorkflowService(config)

    # 존재?? ?을 가?성???? 조문 번호?SQL ?합 질의 ?성
    query = "민법 ??9999?보여?

    result = await service.process_query(query, session_id="test_sql_fallback", enable_checkpoint=False)

    assert isinstance(result, dict), "결과??dict?야 ?니??
    assert "metadata" in result, "metadata가 결과???함?어???니??

    metadata = result.get("metadata") or {}
    assert isinstance(metadata, dict), "metadata??dict?야 ?니??

    # ?우???백 ?시??구현 조건???라 ?략?????으므?존재 ???식??인
    routing = metadata.get("routing") or {}
    if routing:
        assert isinstance(routing, dict)
    if "force_rag_fallback" in metadata:
        assert isinstance(metadata.get("force_rag_fallback"), bool)

    # 최종 ?답???상?으??성?어????
    answer = result.get("answer")
    assert answer is not None, "최종 ????존재?야 ?니??
    # 문자?로 ?렴?었????인 (?태???맷?에 ?라 ?? ???음)
    assert len(str(answer)) > 0, "최종 ?? 문자??길이??0보다 커야 ?니??
