<!-- 6e150640-9273-4cd4-b8f6-a60ccec4f177 6f70fd2d-8e9a-405e-9b86-cd301325142f -->
# 법령용어 주기적 수집 시스템 구축

## 1. 기본 인프라 구축

### 1.1 Law Open API 클라이언트 생성

**파일**: `source/data/law_open_api_client.py`

기존 `scripts/data_collection/legal_term/term_collector.py`에서 사용하는 API 클라이언트가 없으므로 새로 생성:

```python
class LawOpenAPIClient:
    """국가법령정보센터 OPEN API 기본 클라이언트"""
    
    def __init__(self, oc_parameter: str = None):
        self.oc_parameter = oc_parameter or os.getenv("LAW_OPEN_API_OC")
        self.base_url = "https://open.law.go.kr/LSO/openApi"
        self.session = requests.Session()
    
    def get_legal_term_list(self, query: str = "", page: int = 1, 
                           per_page: int = 100) -> Dict[str, Any]:
        """법령용어 목록 조회"""
        params = {
            'OC': self.oc_parameter,
            'target': 'lawTerm',
            'type': 'JSON',
            'query': query,
            'page': page,
            'display': per_page
        }
        response = self.session.get(self.base_url, params=params)
        response.raise_for_status()
        return response.json()
    
    def get_legal_term_detail(self, term_id: str) -> Dict[str, Any]:
        """법령용어 상세 조회"""
        params = {
            'OC': self.oc_parameter,
            'target': 'lawTerm',
            'type': 'JSON',
            'termId': term_id
        }
        response = self.session.get(self.base_url, params=params)
        response.raise_for_status()
        return response.json()
```

### 1.2 증분 수집기 생성

**파일**: `scripts/data_collection/law_open_api/collectors/incremental_legal_term_collector.py`

```python
class IncrementalLegalTermCollector:
    """증분 법령용어 수집기"""
    
    def __init__(self, client: LawOpenAPIClient):
        self.client = client
        self.timestamp_manager = TimestampManager()
        self.change_detector = ChangeDetector()
        self.data_dir = Path("data/raw/law_open_api/legal_terms")
        self.data_dir.mkdir(parents=True, exist_ok=True)
    
    def collect_incremental_updates(self) -> Dict[str, Any]:
        """증분 업데이트 수집"""
        last_collection = self.timestamp_manager.get_last_collection_time("legal_terms")
        
        # 전체 법령용어 목록 조회
        all_terms = self._fetch_all_terms()
        
        # 변경사항 분석
        changes = self.change_detector.analyze_changes(
            "legal_terms", all_terms, last_collection
        )
        
        # 새로운 용어와 업데이트된 용어만 상세 조회
        detailed_terms = []
        for term in changes["new_records"] + [c["new"] for c in changes["updated_records"]]:
            detail = self.client.get_legal_term_detail(term["termId"])
            detailed_terms.append(detail)
            time.sleep(0.1)  # Rate limiting
        
        # 저장
        self._save_incremental_data(changes, detailed_terms)
        
        # 타임스탬프 업데이트
        self.timestamp_manager.update_collection_time("legal_terms")
        
        return {
            "status": "success",
            "new_records": len(changes["new_records"]),
            "updated_records": len(changes["updated_records"]),
            "deleted_records": len(changes["deleted_records"]),
            "collection_time": datetime.now().isoformat()
        }
```

### 1.3 타임스탬프 관리자

**파일**: `scripts/data_collection/law_open_api/utils/timestamp_manager.py`

```python
class TimestampManager:
    """수집 타임스탬프 관리"""
    
    def __init__(self):
        self.timestamp_file = Path("data/raw/law_open_api/metadata/collection_timestamps.json")
        self.timestamp_file.parent.mkdir(parents=True, exist_ok=True)
        self.timestamps = self._load_timestamps()
    
    def get_last_collection_time(self, data_type: str) -> Optional[datetime]:
        """마지막 수집 시간 조회"""
        timestamp_str = self.timestamps.get(data_type, {}).get("last_collection")
        if timestamp_str:
            return datetime.fromisoformat(timestamp_str)
        return None
    
    def update_collection_time(self, data_type: str):
        """수집 시간 업데이트"""
        if data_type not in self.timestamps:
            self.timestamps[data_type] = {}
        
        self.timestamps[data_type].update({
            "last_collection": datetime.now().isoformat(),
            "collection_count": self.timestamps[data_type].get("collection_count", 0) + 1
        })
        self._save_timestamps()
```

### 1.4 변경사항 감지기

**파일**: `scripts/data_collection/law_open_api/utils/change_detector.py`

```python
class ChangeDetector:
    """데이터 변경사항 감지"""
    
    def __init__(self):
        self.data_dir = Path("data/raw/law_open_api/legal_terms")
    
    def analyze_changes(self, data_type: str, new_data: List[Dict], 
                       last_collection: Optional[datetime]) -> Dict[str, Any]:
        """변경사항 분석"""
        # 기존 데이터 로드
        existing_data = self._load_existing_data(data_type)
        
        changes = {
            "new_records": [],
            "updated_records": [],
            "deleted_records": [],
            "unchanged_records": []
        }
        
        existing_ids = {record.get("termId") for record in existing_data}
        
        for record in new_data:
            term_id = record.get("termId")
            if term_id not in existing_ids:
                changes["new_records"].append(record)
            else:
                existing_record = next(
                    (r for r in existing_data if r.get("termId") == term_id), None
                )
                if existing_record and self._has_changes(existing_record, record):
                    changes["updated_records"].append({
                        "old": existing_record,
                        "new": record
                    })
                else:
                    changes["unchanged_records"].append(record)
        
        new_ids = {record.get("termId") for record in new_data}
        for record in existing_data:
            if record.get("termId") not in new_ids:
                changes["deleted_records"].append(record)
        
        return changes
```

## 2. 스케줄링 시스템 구축

### 2.1 일일 스케줄러

**파일**: `scripts/data_collection/law_open_api/schedulers/daily_scheduler.py`

```python
class DailyLegalTermScheduler:
    """일일 법령용어 수집 스케줄러"""
    
    def __init__(self, config: Dict[str, Any]):
        self.config = config
        self.client = LawOpenAPIClient()
        self.collector = IncrementalLegalTermCollector(self.client)
        self.logger = self._setup_logger()
    
    def setup_schedule(self):
        """스케줄 설정"""
        import schedule
        
        # 매일 오전 2시에 법령용어 수집
        schedule.every().day.at("02:00").do(self._collect_legal_terms)
        
        self.logger.info("법령용어 일일 수집 스케줄 설정 완료: 매일 02:00")
    
    def _collect_legal_terms(self):
        """법령용어 수집 실행"""
        self.logger.info("법령용어 일일 수집 시작")
        
        try:
            result = self.collector.collect_incremental_updates()
            
            self.logger.info(f"법령용어 수집 완료: {result}")
            self._log_collection_result(result)
            
        except Exception as e:
            self.logger.error(f"법령용어 수집 실패: {e}")
            self._log_error(e)
    
    def run(self):
        """스케줄러 실행"""
        import schedule
        
        self.logger.info("법령용어 스케줄러 시작")
        
        while True:
            schedule.run_pending()
            time.sleep(60)  # 1분마다 체크
```

### 2.2 스케줄 설정 파일

**파일**: `config/legal_term_collection_config.yaml`

```yaml
# 법령용어 수집 설정
collection:
  enabled: true
  data_type: "legal_terms"
  
  # 스케줄링 설정
  scheduling:
    daily_collection:
      enabled: true
      time: "02:00"
      timeout_minutes: 30
    
    weekly_full_sync:
      enabled: true
      day: "sunday"
      time: "01:00"
      timeout_minutes: 60

# API 설정
api:
  base_url: "https://open.law.go.kr/LSO/openApi"
  timeout: 30
  max_retries: 3
  retry_delay: 5

# 로깅 설정
logging:
  level: "INFO"
  log_dir: "logs/legal_term_collection"
  max_file_size_mb: 10
  backup_count: 5
```

## 3. 실행 스크립트 생성

### 3.1 스케줄된 수집 시작 스크립트

**파일**: `scripts/data_collection/law_open_api/scripts/start_legal_term_scheduler.py`

```python
#!/usr/bin/env python3
"""법령용어 스케줄된 수집 시작"""

import sys
import yaml
from pathlib import Path

project_root = Path(__file__).parent.parent.parent.parent
sys.path.append(str(project_root))

from scripts.data_collection.law_open_api.schedulers.daily_scheduler import DailyLegalTermScheduler

def main():
    # 설정 로드
    config_path = project_root / "config/legal_term_collection_config.yaml"
    with open(config_path) as f:
        config = yaml.safe_load(f)
    
    # 스케줄러 초기화 및 실행
    scheduler = DailyLegalTermScheduler(config)
    scheduler.setup_schedule()
    scheduler.run()

if __name__ == "__main__":
    main()
```

### 3.2 수동 수집 스크립트

**파일**: `scripts/data_collection/law_open_api/scripts/manual_collect_legal_terms.py`

```python
#!/usr/bin/env python3
"""법령용어 수동 수집"""

import sys
import argparse
import yaml
from pathlib import Path
from datetime import datetime

project_root = Path(__file__).parent.parent.parent.parent
sys.path.append(str(project_root))

from source.data.law_open_api_client import LawOpenAPIClient
from scripts.data_collection.law_open_api.collectors.incremental_legal_term_collector import IncrementalLegalTermCollector

def main():
    parser = argparse.ArgumentParser(description='법령용어 수동 수집')
    parser.add_argument('--mode', choices=['incremental', 'full'], default='incremental',
                       help='수집 모드 (incremental: 증분, full: 전체)')
    parser.add_argument('--output', type=str, help='출력 디렉토리')
    args = parser.parse_args()
    
    print(f"법령용어 수집 시작 - 모드: {args.mode}")
    print(f"시작 시간: {datetime.now()}")
    
    # 클라이언트 초기화
    client = LawOpenAPIClient()
    collector = IncrementalLegalTermCollector(client)
    
    # 수집 실행
    if args.mode == 'incremental':
        result = collector.collect_incremental_updates()
    else:
        result = collector.collect_full_data()
    
    print(f"\n수집 완료:")
    print(f"  - 새로운 레코드: {result['new_records']}")
    print(f"  - 업데이트된 레코드: {result['updated_records']}")
    print(f"  - 삭제된 레코드: {result['deleted_records']}")
    print(f"  - 수집 시간: {result['collection_time']}")

if __name__ == "__main__":
    main()
```

### 3.3 수집 상태 모니터링 스크립트

**파일**: `scripts/data_collection/law_open_api/scripts/monitor_collection_status.py`

```python
#!/usr/bin/env python3
"""법령용어 수집 상태 모니터링"""

import sys
import json
from pathlib import Path
from datetime import datetime

project_root = Path(__file__).parent.parent.parent.parent
sys.path.append(str(project_root))

from scripts.data_collection.law_open_api.utils.timestamp_manager import TimestampManager

def main():
    timestamp_mgr = TimestampManager()
    
    print("=" * 60)
    print("법령용어 수집 상태")
    print("=" * 60)
    
    last_collection = timestamp_mgr.get_last_collection_time("legal_terms")
    
    if last_collection:
        print(f"마지막 수집 시간: {last_collection}")
        print(f"경과 시간: {datetime.now() - last_collection}")
    else:
        print("수집 이력 없음")
    
    # 수집 로그 확인
    log_dir = Path("logs/legal_term_collection")
    if log_dir.exists():
        log_files = sorted(log_dir.glob("*.log"), key=lambda x: x.stat().st_mtime, reverse=True)
        if log_files:
            print(f"\n최근 로그 파일: {log_files[0]}")
    
    print("=" * 60)

if __name__ == "__main__":
    main()
```

## 4. 배치 파일 생성 (Windows)

### 4.1 스케줄러 시작 배치 파일

**파일**: `scripts/data_collection/law_open_api/scripts/start_scheduler.bat`

```batch
@echo off
echo 법령용어 스케줄러 시작...
cd /d %~dp0\..\..\..\..
python scripts/data_collection/law_open_api/scripts/start_legal_term_scheduler.py
pause
```

### 4.2 수동 수집 배치 파일

**파일**: `scripts/data_collection/law_open_api/scripts/manual_collect.bat`

```batch
@echo off
echo 법령용어 수동 수집 시작...
cd /d %~dp0\..\..\..\..
python scripts/data_collection/law_open_api/scripts/manual_collect_legal_terms.py --mode incremental
pause
```

## 5. 로깅 시스템

### 5.1 로깅 유틸리티

**파일**: `scripts/data_collection/law_open_api/utils/logging_utils.py`

```python
import logging
from pathlib import Path
from datetime import datetime

def setup_collection_logger(name: str, log_dir: str = "logs/legal_term_collection") -> logging.Logger:
    """수집 로거 설정"""
    log_path = Path(log_dir)
    log_path.mkdir(parents=True, exist_ok=True)
    
    logger = logging.getLogger(name)
    logger.setLevel(logging.INFO)
    
    # 파일 핸들러
    log_file = log_path / f"collection_{datetime.now().strftime('%Y%m%d')}.log"
    file_handler = logging.FileHandler(log_file, encoding='utf-8')
    file_handler.setLevel(logging.INFO)
    
    # 콘솔 핸들러
    console_handler = logging.StreamHandler()
    console_handler.setLevel(logging.INFO)
    
    # 포맷터
    formatter = logging.Formatter(
        '%(asctime)s - %(name)s - %(levelname)s - %(message)s'
    )
    file_handler.setFormatter(formatter)
    console_handler.setFormatter(formatter)
    
    logger.addHandler(file_handler)
    logger.addHandler(console_handler)
    
    return logger
```

## 6. 디렉토리 구조

```
scripts/data_collection/law_open_api/
├── __init__.py
├── collectors/
│   ├── __init__.py
│   └── incremental_legal_term_collector.py
├── schedulers/
│   ├── __init__.py
│   └── daily_scheduler.py
├── utils/
│   ├── __init__.py
│   ├── timestamp_manager.py
│   ├── change_detector.py
│   └── logging_utils.py
└── scripts/
    ├── start_legal_term_scheduler.py
    ├── manual_collect_legal_terms.py
    ├── monitor_collection_status.py
    ├── start_scheduler.bat
    └── manual_collect.bat

data/raw/law_open_api/
├── legal_terms/
│   ├── incremental/
│   │   └── YYYYMMDD/
│   │       ├── new_records.json
│   │       ├── updated_records.json
│   │       └── deleted_records.json
│   └── full/
│       └── legal_terms_YYYYMMDD.json
└── metadata/
    ├── collection_timestamps.json
    └── change_log.json

config/
└── legal_term_collection_config.yaml

logs/legal_term_collection/
└── collection_YYYYMMDD.log
```

## 실행 방법

### 자동 스케줄링 실행

```bash
# Python 스크립트로 실행
python scripts/data_collection/law_open_api/scripts/start_legal_term_scheduler.py

# 또는 배치 파일로 실행 (Windows)
scripts/data_collection/law_open_api/scripts/start_scheduler.bat
```

### 수동 수집 실행

```bash
# 증분 수집
python scripts/data_collection/law_open_api/scripts/manual_collect_legal_terms.py --mode incremental

# 전체 수집
python scripts/data_collection/law_open_api/scripts/manual_collect_legal_terms.py --mode full

# 또는 배치 파일로 실행 (Windows)
scripts/data_collection/law_open_api/scripts/manual_collect.bat
```

### 수집 상태 확인

```bash
python scripts/data_collection/law_open_api/scripts/monitor_collection_status.py
```

## 필요한 패키지

requirements.txt에 추가:

```
schedule>=1.1.0
pyyaml>=6.0
requests>=2.28.0
```

### To-dos

- [ ] Law Open API 클라이언트 생성 (source/data/law_open_api_client.py)
- [ ] 증분 수집기 생성 (incremental_legal_term_collector.py)
- [ ] 유틸리티 모듈 생성 (timestamp_manager.py, change_detector.py, logging_utils.py)
- [ ] 일일 스케줄러 생성 (daily_scheduler.py)
- [ ] 설정 파일 생성 (legal_term_collection_config.yaml)
- [ ] 실행 스크립트 생성 (start_legal_term_scheduler.py, manual_collect_legal_terms.py, monitor_collection_status.py)
- [ ] 배치 파일 생성 (start_scheduler.bat, manual_collect.bat)
- [ ] 필요한 디렉토리 구조 생성
- [ ] 수동 수집 테스트 실행
- [ ] 스케줄된 수집 테스트 실행